---
phase: 10-visualizations-and-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/dashboard/public/vendor/cytoscape.min.js
  - src/dashboard/public/vendor/vis-timeline-graph2d.min.js
  - src/dashboard/public/vendor/vis-timeline-graph2d.min.css
  - src/dashboard/public/index.html
  - src/dashboard/public/style.css
  - src/dashboard/public/app.js
autonomous: true
requirements: [VIZ-07]

must_haves:
  truths:
    - "Dashboard has a dark mode toggle button in the header"
    - "Clicking the toggle switches all colors between light and dark themes"
    - "Theme preference persists in localStorage across page reloads"
    - "System prefers-color-scheme is respected when no localStorage preference exists"
    - "Decisions tab has Table/Timeline view-mode toggle buttons"
    - "Graph tab has Table/Visual view-mode toggle buttons"
    - "Vendor library files exist and load without console errors"
  artifacts:
    - path: "src/dashboard/public/vendor/cytoscape.min.js"
      provides: "Cytoscape.js 3.33.1 UMD bundle"
    - path: "src/dashboard/public/vendor/vis-timeline-graph2d.min.js"
      provides: "vis-timeline 7.7.3 standalone UMD bundle"
    - path: "src/dashboard/public/vendor/vis-timeline-graph2d.min.css"
      provides: "vis-timeline 7.7.3 styles"
    - path: "src/dashboard/public/style.css"
      provides: "Dark mode CSS custom properties under [data-theme=dark]"
      contains: "[data-theme=\"dark\"]"
    - path: "src/dashboard/public/app.js"
      provides: "Theme toggle logic with localStorage persistence"
      contains: "toggleTheme"
  key_links:
    - from: "src/dashboard/public/index.html"
      to: "vendor/cytoscape.min.js"
      via: "script tag with defer"
      pattern: "vendor/cytoscape"
    - from: "src/dashboard/public/index.html"
      to: "vendor/vis-timeline-graph2d.min.js"
      via: "script tag with defer"
      pattern: "vendor/vis-timeline"
    - from: "src/dashboard/public/app.js"
      to: "localStorage"
      via: "setItem/getItem for theme persistence"
      pattern: "localStorage.*twining-theme"
---

<objective>
Vendor visualization libraries, implement dark mode theme, and scaffold view-mode toggles for Decisions and Graph tabs.

Purpose: Establish the foundation that both visualization plans (10-02 timeline, 10-03 graph) depend on: vendor libraries loaded, dark mode CSS variables defined, view-mode toggle HTML/CSS in place, and theme toggle logic wired up.

Output: Vendor JS/CSS files in public/vendor/, dark mode working end-to-end, view-mode toggle buttons visible in Decisions and Graph tabs (visual views show placeholder containers until Plans 02/03 populate them).
</objective>

<execution_context>
@/Users/dave/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dave/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-visualizations-and-polish/10-RESEARCH.md

@src/dashboard/public/index.html
@src/dashboard/public/style.css
@src/dashboard/public/app.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Download vendor libraries and add dark mode CSS</name>
  <files>
    src/dashboard/public/vendor/cytoscape.min.js
    src/dashboard/public/vendor/vis-timeline-graph2d.min.js
    src/dashboard/public/vendor/vis-timeline-graph2d.min.css
    src/dashboard/public/style.css
  </files>
  <action>
    1. Create `src/dashboard/public/vendor/` directory.

    2. Download vendor files using curl:
       - `curl -o src/dashboard/public/vendor/cytoscape.min.js "https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.33.1/cytoscape.umd.min.js"`
       - `curl -o src/dashboard/public/vendor/vis-timeline-graph2d.min.js "https://unpkg.com/vis-timeline@7.7.3/standalone/umd/vis-timeline-graph2d.min.js"`
       - `curl -o src/dashboard/public/vendor/vis-timeline-graph2d.min.css "https://unpkg.com/vis-timeline@7.7.3/styles/vis-timeline-graph2d.min.css"`

    3. Verify all three files downloaded successfully (non-zero size, contain expected content).

    4. Add dark mode CSS custom properties to style.css. After the existing `:root { ... }` block, add a `[data-theme="dark"]` block that overrides all CSS variables with dark equivalents:
       ```css
       [data-theme="dark"] {
         --bg: #0f172a;
         --text: #e2e8f0;
         --card-bg: #1e293b;
         --card-border: #334155;
         --accent: #60a5fa;
         --success: #4ade80;
         --error: #f87171;
         --warning: #fbbf24;
         --muted: #94a3b8;
       }
       ```

    5. Add vis-timeline dark mode overrides at end of style.css (see research Pattern 4 for exact selectors):
       - `[data-theme="dark"] .vis-timeline` border-color
       - `[data-theme="dark"] .vis-item` background/border/color
       - `[data-theme="dark"] .vis-time-axis .vis-text` color

    6. Add confidence/status color-coding classes for timeline items (both light and dark variants) from research code examples section "vis-timeline: Confidence + Status Color-Coding":
       - `.vis-item.confidence-high`, `.vis-item.confidence-medium`, `.vis-item.confidence-low`
       - `.vis-item.status-provisional`, `.vis-item.status-superseded`, `.vis-item.status-overridden`
       - Dark mode variants for all of the above

    7. Add view-mode toggle button styles:
       ```css
       .view-toggle { display: flex; gap: 0.25rem; margin-bottom: 0.75rem; }
       .view-btn { padding: 0.25rem 0.75rem; border: 1px solid var(--card-border); background: var(--bg); color: var(--text); border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
       .view-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
       ```

    8. Add visualization container styles:
       ```css
       #timeline-container { height: 400px; border: 1px solid var(--card-border); border-radius: 4px; background: var(--card-bg); }
       #graph-canvas { height: 500px; border: 1px solid var(--card-border); border-radius: 4px; background: var(--card-bg); }
       ```

    9. Add theme toggle button style in header:
       ```css
       #theme-toggle { background: none; border: 1px solid var(--card-border); border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 1.1rem; color: var(--text); }
       #theme-toggle:hover { background: var(--card-border); }
       ```

    10. Add `.graph-legend` styles for the entity type color legend (a simple inline list with colored dots).
  </action>
  <verify>
    - `ls -la src/dashboard/public/vendor/` shows 3 files, all non-zero size
    - `grep 'data-theme' src/dashboard/public/style.css` returns dark mode selector
    - `grep 'confidence-high' src/dashboard/public/style.css` returns timeline color classes
    - `grep 'view-toggle' src/dashboard/public/style.css` returns toggle styles
  </verify>
  <done>Vendor libraries downloaded, dark mode CSS variables defined, timeline color-coding classes added, view-mode toggle and visualization container styles ready.</done>
</task>

<task type="auto">
  <name>Task 2: Add HTML scaffolding and dark mode JS logic</name>
  <files>
    src/dashboard/public/index.html
    src/dashboard/public/app.js
  </files>
  <action>
    1. In index.html `<head>`, add vendor script/CSS tags BEFORE `app.js`:
       ```html
       <link rel="stylesheet" href="vendor/vis-timeline-graph2d.min.css">
       <script src="vendor/cytoscape.min.js" defer></script>
       <script src="vendor/vis-timeline-graph2d.min.js" defer></script>
       ```
       Keep the existing `app.js` script tag last (with defer) so it loads after vendor libs.

    2. In header, add theme toggle button between the global-scope-filter and header-status divs:
       ```html
       <button id="theme-toggle" title="Toggle dark mode" aria-label="Toggle dark mode">
         <span id="theme-icon">&#9789;</span>
       </button>
       ```

    3. In the Decisions tab (`#tab-decisions`), wrap the existing table and pagination in a `<div class="view-table" id="decisions-table-view">` and add view-mode toggle buttons and a timeline container:
       ```html
       <div class="view-toggle" id="decisions-view-toggle">
         <button class="view-btn active" data-view="table" data-tab="decisions">Table</button>
         <button class="view-btn" data-view="timeline" data-tab="decisions">Timeline</button>
       </div>
       <div class="view-table" id="decisions-table-view">
         <!-- existing table + pagination (unchanged) -->
       </div>
       <div class="view-visual" id="decisions-timeline-view" style="display:none">
         <div id="timeline-container"></div>
       </div>
       ```
       The `content-area` div and detail panel remain unchanged -- the detail panel is shared between both views.

    4. In the Graph tab (`#tab-graph`), similarly wrap the existing table/pagination/relations-info in a `<div class="view-table" id="graph-table-view">` and add view-mode toggle buttons and a graph canvas container:
       ```html
       <div class="view-toggle" id="graph-view-toggle">
         <button class="view-btn active" data-view="table" data-tab="graph">Table</button>
         <button class="view-btn" data-view="visual" data-tab="graph">Visual</button>
       </div>
       <div class="view-table" id="graph-table-view">
         <!-- existing table + pagination + relations-info (unchanged) -->
       </div>
       <div class="view-visual" id="graph-visual-view" style="display:none">
         <div id="graph-canvas"></div>
         <div class="graph-legend" id="graph-legend"></div>
       </div>
       ```

    5. In app.js, add theme initialization and toggle logic. At the TOP of the DOMContentLoaded handler (or the equivalent init flow), call `initTheme()`:
       ```javascript
       function initTheme() {
         var saved = localStorage.getItem('twining-theme');
         if (saved) {
           setTheme(saved);
         } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
           setTheme('dark');
         }
         if (window.matchMedia) {
           window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
             if (!localStorage.getItem('twining-theme')) {
               setTheme(e.matches ? 'dark' : 'light');
             }
           });
         }
       }

       function setTheme(theme) {
         document.documentElement.setAttribute('data-theme', theme);
         var icon = document.getElementById('theme-icon');
         if (icon) icon.textContent = theme === 'dark' ? '\u2600' : '\u263D';
       }

       function toggleTheme() {
         var current = document.documentElement.getAttribute('data-theme') || 'light';
         var next = current === 'dark' ? 'light' : 'dark';
         setTheme(next);
         localStorage.setItem('twining-theme', next);
         // Refresh cytoscape styles if graph is initialized (for Plan 10-03)
         if (window.cyInstance) {
           window.cyInstance.style(buildGraphStyles());
         }
       }
       ```

    6. Wire theme toggle button click handler: `document.getElementById('theme-toggle').addEventListener('click', toggleTheme);`

    7. Add view-mode toggle logic. Listen for clicks on `.view-btn` elements:
       ```javascript
       document.querySelectorAll('.view-btn').forEach(function(btn) {
         btn.addEventListener('click', function() {
           var tab = btn.getAttribute('data-tab');
           var view = btn.getAttribute('data-view');
           toggleView(tab, view);
         });
       });

       function toggleView(tab, viewName) {
         // Update active button state
         var toggleContainer = document.getElementById(tab + '-view-toggle');
         if (toggleContainer) {
           toggleContainer.querySelectorAll('.view-btn').forEach(function(b) {
             b.classList.toggle('active', b.getAttribute('data-view') === viewName);
           });
         }
         if (tab === 'decisions') {
           document.getElementById('decisions-table-view').style.display = viewName === 'table' ? 'block' : 'none';
           document.getElementById('decisions-timeline-view').style.display = viewName === 'timeline' ? 'block' : 'none';
           if (viewName === 'timeline' && typeof initTimeline === 'function') initTimeline();
         }
         if (tab === 'graph') {
           document.getElementById('graph-table-view').style.display = viewName === 'table' ? 'block' : 'none';
           document.getElementById('graph-visual-view').style.display = viewName === 'visual' ? 'block' : 'none';
           if (viewName === 'visual' && typeof initGraphVis === 'function') initGraphVis();
         }
       }
       ```
       Note: `initTimeline` and `initGraphVis` are called if they exist but won't exist yet -- they'll be added in Plans 02 and 03. This is safe because of the `typeof` guard.

    8. Add stub functions `initTimeline` and `initGraphVis` that are no-ops for now (Plans 02/03 will replace them). Also add a stub `buildGraphStyles` function that returns an empty array.

    9. Call `initTheme()` early in the DOMContentLoaded handler.
  </action>
  <verify>
    - `grep 'vendor/cytoscape' src/dashboard/public/index.html` returns script tag
    - `grep 'vendor/vis-timeline' src/dashboard/public/index.html` returns script + link tags
    - `grep 'theme-toggle' src/dashboard/public/index.html` returns button element
    - `grep 'toggleTheme' src/dashboard/public/app.js` returns function definition
    - `grep 'view-toggle' src/dashboard/public/index.html` returns toggle containers for both tabs
    - `grep 'timeline-container' src/dashboard/public/index.html` returns div
    - `grep 'graph-canvas' src/dashboard/public/index.html` returns div
    - `npm run build` succeeds (postbuild copies vendor files to dist/)
    - `npm test` passes with zero regressions
  </verify>
  <done>Vendor libraries load via script tags, dark mode toggle works with localStorage persistence and system preference detection, view-mode toggles visible in Decisions and Graph tabs, visualization containers ready for Plans 02/03.</done>
</task>

</tasks>

<verification>
1. Open dashboard in browser, verify no console errors from vendor library loading
2. Click theme toggle -- all dashboard colors switch between light and dark
3. Reload page -- theme preference persists
4. Decisions tab shows Table/Timeline toggle buttons
5. Graph tab shows Table/Visual toggle buttons
6. Clicking "Timeline" button hides table and shows (empty) timeline container
7. Clicking "Visual" button hides table and shows (empty) graph canvas
8. `npm run build` succeeds
9. `npm test` passes with zero regressions
</verification>

<success_criteria>
- Dark mode theme fully functional with toggle, persistence, and system preference detection
- Vendor libraries present in public/vendor/ and loaded without errors
- View-mode toggle scaffolding in place for Decisions and Graph tabs
- No regressions in existing tests or dashboard functionality
</success_criteria>

<output>
After completion, create `.planning/phases/10-visualizations-and-polish/10-01-SUMMARY.md`
</output>
