---
phase: 10-visualizations-and-polish
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/dashboard/public/app.js
  - src/dashboard/public/style.css
autonomous: true
requirements: [VIZ-01, VIZ-02, VIZ-06]

must_haves:
  truths:
    - "User can switch Decisions tab to Timeline view and see decisions positioned chronologically"
    - "User can click a timeline item and see full decision details in the detail panel"
    - "Timeline items are color-coded by confidence level (green=high, amber=medium, red=low)"
    - "Non-active decisions (provisional, superseded, overridden) have distinct visual styles"
    - "Timeline fits to show all items on initial render"
    - "Timeline is created once and updated on data refresh (no recreation)"
  artifacts:
    - path: "src/dashboard/public/app.js"
      provides: "initTimeline function with vis-timeline integration"
      contains: "vis.Timeline"
    - path: "src/dashboard/public/app.js"
      provides: "Timeline select handler wired to fetchDecisionDetail"
      contains: "timeline.on"
  key_links:
    - from: "src/dashboard/public/app.js"
      to: "vis.Timeline"
      via: "initTimeline creates vis.Timeline instance"
      pattern: "new vis\\.Timeline"
    - from: "src/dashboard/public/app.js"
      to: "fetchDecisionDetail"
      via: "timeline select event triggers detail fetch"
      pattern: "timeline\\.on.*select"
    - from: "src/dashboard/public/app.js"
      to: "state.decisions.data"
      via: "timeline items built from decisions data"
      pattern: "vis\\.DataSet"
---

<objective>
Implement the decision timeline visualization using vis-timeline within the Decisions tab.

Purpose: Give users a chronological view of decisions with confidence-based color-coding and click-to-inspect, complementing the existing table view.

Output: Working timeline visualization that shows all decisions on a time axis, color-coded by confidence/status, with click-to-select wired to the existing detail panel.
</objective>

<execution_context>
@/Users/dave/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dave/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-visualizations-and-polish/10-RESEARCH.md
@.planning/phases/10-visualizations-and-polish/10-01-SUMMARY.md

@src/dashboard/public/index.html
@src/dashboard/public/style.css
@src/dashboard/public/app.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement vis-timeline decision visualization</name>
  <files>
    src/dashboard/public/app.js
  </files>
  <action>
    Replace the stub `initTimeline` function in app.js with a full implementation.

    CRITICAL CONSTRAINTS from research:
    - Create the vis.Timeline instance ONCE and store it (e.g., `window.timelineInstance`). Never recreate on tab switch or data refresh.
    - The timeline container must be VISIBLE when `new vis.Timeline()` is called (display:none = broken layout). The `toggleView` function already makes it visible before calling initTimeline.
    - Use `vis.DataSet` for items so they can be updated incrementally on poll refresh.

    Implementation details:

    1. Define confidence/status class mappings at module scope:
       ```javascript
       var CONFIDENCE_CLASSES = { high: 'confidence-high', medium: 'confidence-medium', low: 'confidence-low' };
       var STATUS_CLASSES = { provisional: 'status-provisional', superseded: 'status-superseded', overridden: 'status-overridden' };
       ```

    2. Create `initTimeline()` function:
       - Guard: if `window.timelineInstance` already exists, call `updateTimelineData()` instead and return.
       - Build a `vis.DataSet` from `state.decisions.data`, mapping each decision to:
         ```javascript
         { id: d.id, content: truncate(d.summary, 60), start: d.timestamp,
           className: getDecisionClassName(d), title: d.summary + ' [' + d.status + ', ' + d.confidence + ']' }
         ```
       - Create helper `getDecisionClassName(d)`: returns STATUS_CLASSES[d.status] if status is not 'active', otherwise CONFIDENCE_CLASSES[d.confidence] or empty string.
       - Create helper `truncate(str, len)`: returns str if shorter than len, otherwise str.substring(0, len) + '...'. (This may already exist in app.js -- reuse if so.)
       - Create the timeline:
         ```javascript
         var container = document.getElementById('timeline-container');
         var options = {
           zoomMin: 1000 * 60 * 60,
           zoomMax: 1000 * 60 * 60 * 24 * 365,
           orientation: { axis: 'top' },
           selectable: true,
           tooltip: { followMouse: true },
           margin: { item: 10 }
         };
         window.timelineInstance = new vis.Timeline(container, window.timelineDataSet, options);
         ```
       - Store the DataSet as `window.timelineDataSet` for later updates.
       - Wire the select event:
         ```javascript
         window.timelineInstance.on('select', function(properties) {
           if (properties.items.length > 0) {
             var id = properties.items[0];
             state.decisions.selectedId = id;
             fetchDecisionDetail(id);
           }
         });
         ```
       - Call `window.timelineInstance.fit()` after creation to show all items.

    3. Create `updateTimelineData()` function for poll refreshes:
       - Build new items array from `state.decisions.data` (same mapping as above).
       - Apply global scope filter: only include decisions that pass `matchesGlobalScope(d.scope)` (use the same applyGlobalScope logic or its predicate).
       - Call `window.timelineDataSet.clear()` then `window.timelineDataSet.add(newItems)`.
       - Do NOT call `fit()` on update (would reset user's zoom/pan position).

    4. Hook into the existing polling/refresh cycle: In the `renderDecisions()` function (or wherever decisions data is refreshed after a poll), add a check: if timeline view is currently active (decisions-timeline-view is visible), call `updateTimelineData()`.

    5. Ensure the existing `fetchDecisionDetail(id)` function works for timeline selections. It should already exist from Phase 8/9 -- verify it populates the detail panel correctly. The timeline select handler sets `state.decisions.selectedId` the same way the table click handler does.
  </action>
  <verify>
    - `grep 'vis.Timeline' src/dashboard/public/app.js` returns constructor call
    - `grep 'timelineInstance' src/dashboard/public/app.js` returns multiple references (creation + guard + update)
    - `grep 'timelineDataSet' src/dashboard/public/app.js` returns DataSet creation and update calls
    - `grep 'timeline.on' src/dashboard/public/app.js` OR `grep "timelineInstance.on" src/dashboard/public/app.js` returns select event handler
    - `npm run build` succeeds
    - `npm test` passes with zero regressions
  </verify>
  <done>Timeline visualization renders decisions chronologically, color-coded by confidence/status, with click-to-select wired to the detail panel. Timeline instance is created once, data updated incrementally on poll refresh.</done>
</task>

<task type="auto">
  <name>Task 2: Polish timeline styles and ensure dark mode compatibility</name>
  <files>
    src/dashboard/public/style.css
    src/dashboard/public/app.js
  </files>
  <action>
    1. Review the confidence/status color-coding classes already added in Plan 10-01. If any are missing or need adjustment for actual vis-timeline rendering, fix them. Key classes needed:
       - `.vis-item.confidence-high` -- green tones (light + dark mode)
       - `.vis-item.confidence-medium` -- amber tones (light + dark mode)
       - `.vis-item.confidence-low` -- red tones (light + dark mode)
       - `.vis-item.status-provisional` -- dashed border, amber
       - `.vis-item.status-superseded` -- muted, line-through
       - `.vis-item.status-overridden` -- muted, red, line-through

    2. Verify vis-timeline renders correctly in dark mode. The dark mode overrides for `.vis-timeline`, `.vis-item`, `.vis-time-axis .vis-text` should have been added in Plan 10-01. If the timeline background or axis labels don't look right in dark mode, add additional selectors:
       - `[data-theme="dark"] .vis-panel.vis-background` background-color
       - `[data-theme="dark"] .vis-panel.vis-center` background-color
       - `[data-theme="dark"] .vis-labelset .vis-label` color/background
       - `[data-theme="dark"] .vis-current-time` background-color override

    3. Add a small legend or note below the timeline indicating the color coding: "High = green, Medium = amber, Low = red. Dashed = provisional, Strikethrough = superseded/overridden." Use textContent (not innerHTML) for XSS safety. This can be a static `<p>` element in the timeline view container, or dynamically created in `initTimeline()`.

    4. Test dark mode toggle while timeline is visible -- ensure colors update correctly. vis-timeline uses DOM elements (not canvas), so CSS variable changes propagate automatically. However, the confidence/status classes use hard-coded colors (not variables) -- they need both light and dark variants in CSS (which should already exist from Plan 10-01).
  </action>
  <verify>
    - Open dashboard, switch to Decisions tab, toggle to Timeline view
    - Toggle dark mode -- timeline background, axis labels, and items all update
    - Items show correct confidence colors (verify at least one each of high/medium/low if data allows)
    - Non-active decisions show distinct styling (dashed/strikethrough)
    - `npm run build` succeeds
    - `npm test` passes
  </verify>
  <done>Timeline visualization looks correct in both light and dark modes, with clear confidence/status color-coding and a legend explaining the colors.</done>
</task>

</tasks>

<verification>
1. Switch to Decisions tab, click "Timeline" toggle -- decisions appear on time axis
2. Hover over timeline items -- tooltip shows full summary with status and confidence
3. Click a timeline item -- detail panel shows full decision details (same as table click)
4. Items are color-coded: green (high confidence), amber (medium), red (low)
5. Provisional decisions have dashed borders; superseded/overridden are muted with strikethrough
6. Toggle dark mode while on timeline -- all colors update correctly
7. Switch back to Table view -- table still works normally
8. Data refreshes via polling update the timeline without resetting zoom/pan
9. `npm run build` succeeds
10. `npm test` passes with zero regressions
</verification>

<success_criteria>
- Decision timeline renders chronologically from /api/decisions data
- Click-to-select populates the shared detail panel
- Confidence-based color-coding visually distinguishes high/medium/low/provisional decisions
- Dark mode works for timeline
- No regressions
</success_criteria>

<output>
After completion, create `.planning/phases/10-visualizations-and-polish/10-02-SUMMARY.md`
</output>
