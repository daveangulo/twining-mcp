---
phase: 10-visualizations-and-polish
plan: 03
type: execute
wave: 3
depends_on: ["10-01"]
files_modified:
  - src/dashboard/public/app.js
  - src/dashboard/public/style.css
autonomous: true
requirements: [VIZ-03, VIZ-04, VIZ-05]

must_haves:
  truths:
    - "User can switch Graph tab to Visual view and see entities as nodes in a force-directed layout"
    - "User can zoom and pan the graph visualization"
    - "User can click a node to see entity details in the detail panel"
    - "User can click a node to expand its neighbors (edges and connected nodes appear)"
    - "Graph nodes are color-coded by entity type with a visible legend"
    - "Graph visualization works correctly in both light and dark modes"
    - "Graph instance is created once and updated on data refresh (no recreation)"
  artifacts:
    - path: "src/dashboard/public/app.js"
      provides: "initGraphVis function with cytoscape.js integration"
      contains: "cytoscape"
    - path: "src/dashboard/public/app.js"
      provides: "buildGraphStyles function for theme-aware cytoscape styling"
      contains: "buildGraphStyles"
    - path: "src/dashboard/public/app.js"
      provides: "Entity type color map for graph node coloring"
      contains: "ENTITY_COLORS"
  key_links:
    - from: "src/dashboard/public/app.js"
      to: "cytoscape"
      via: "initGraphVis creates cytoscape instance"
      pattern: "cytoscape\\("
    - from: "src/dashboard/public/app.js"
      to: "state.graph"
      via: "graph elements built from state.graph.data and relations"
      pattern: "state\\.graph\\.data"
    - from: "src/dashboard/public/app.js"
      to: "buildGraphStyles"
      via: "toggleTheme refreshes cytoscape styles"
      pattern: "cyInstance.*style.*buildGraphStyles"
---

<objective>
Implement the interactive knowledge graph visualization using cytoscape.js within the Graph tab.

Purpose: Give users a visual representation of entities and their relationships with zoom, pan, click-to-inspect, click-to-expand-neighbors, and entity-type color-coding.

Output: Working force-directed graph visualization in the Graph tab with interactive navigation, color-coded nodes, neighbor expansion, and dark mode compatibility.
</objective>

<execution_context>
@/Users/dave/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dave/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-visualizations-and-polish/10-RESEARCH.md
@.planning/phases/10-visualizations-and-polish/10-01-SUMMARY.md

@src/dashboard/public/index.html
@src/dashboard/public/style.css
@src/dashboard/public/app.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement cytoscape.js graph visualization with click-to-expand</name>
  <files>
    src/dashboard/public/app.js
  </files>
  <action>
    Replace the stub `initGraphVis` and `buildGraphStyles` functions in app.js with full implementations.

    CRITICAL CONSTRAINTS from research:
    - Create the cytoscape instance ONCE and store as `window.cyInstance`. Never recreate on tab switch or poll refresh.
    - The `#graph-canvas` container MUST be visible and have explicit dimensions when `cytoscape()` is called. Plan 10-01 set `height: 500px` in CSS. The `toggleView` function makes the container visible before calling initGraphVis.
    - Cytoscape.js uses its own style system, NOT CSS. Theme changes require `cy.style(buildGraphStyles())` -- already hooked into `toggleTheme()` from Plan 10-01.

    Implementation details:

    1. Define entity type color map at module scope:
       ```javascript
       var ENTITY_COLORS = {
         module: '#3b82f6',
         'function': '#8b5cf6',
         'class': '#06b6d4',
         file: '#6b7280',
         concept: '#f59e0b',
         pattern: '#10b981',
         dependency: '#ef4444',
         api_endpoint: '#ec4899'
       };
       ```

    2. Replace the stub `buildGraphStyles()` function with the full implementation from research Pattern 2. This function reads the current theme (light/dark) and returns an array of cytoscape style objects:
       - Base `node` style: label from data(label), text-valign bottom, text-halign center, font-size 10px, width/height 30, color based on theme
       - Per-type node styles: `node[type="module"]` with background-color from ENTITY_COLORS, etc. for all 8 entity types
       - Base `edge` style: width 2, line-color/target-arrow-color based on theme, target-arrow-shape triangle, curve-style bezier, label from data(label), font-size 8px
       - Selected node style: border-width 3, border-color accent

    3. Replace the stub `initGraphVis()` function:
       - Guard: if `window.cyInstance` already exists, call `updateGraphData()` instead and return.
       - Build elements array from `state.graph.data` (entities -> nodes) and `state.graph.relations` (relations -> edges). Use `state.graph` which is already fetched by the polling cycle. The relations may be in `state.graph.relations` or need to be extracted from the `/api/graph` response (check the existing app.js data structure).
       - For entities: `{ data: { id: entity.id, label: entity.name, type: entity.type } }`
       - For relations: `{ data: { id: rel.id || (rel.source + '-' + rel.target), source: rel.source, target: rel.target, label: rel.type } }`
       - Create cytoscape instance:
         ```javascript
         window.cyInstance = cytoscape({
           container: document.getElementById('graph-canvas'),
           elements: elements,
           layout: { name: 'cose', animate: true, animationDuration: 500, nodeRepulsion: function() { return 8000; } },
           style: buildGraphStyles(),
           minZoom: 0.2,
           maxZoom: 5
         });
         ```
       - Wire tap event on nodes for detail panel:
         ```javascript
         window.cyInstance.on('tap', 'node', function(evt) {
           var nodeId = evt.target.id();
           var entity = state.graph.data.find(function(e) { return e.id === nodeId; });
           if (entity) {
             state.graph.selectedId = nodeId;
             renderGraphDetail(entity);
           }
         });
         ```
       - Wire tap event on nodes for neighbor expansion (client-side, using existing relation data):
         When a node is tapped, check if it's already been "expanded" (track in `state.graph.expandedNodes = {}`).
         If not expanded, find all relations in `state.graph.relations` where source or target matches the nodeId. For each connected entity not yet in the graph, add it via `cy.add()`. Then re-run layout on the new elements with `fit: false` to avoid resetting the viewport.
         Mark the node as expanded.

    4. Create `updateGraphData()` function for poll refreshes:
       - Apply global scope filter to determine which entities to show.
       - Compute which nodes/edges are new vs removed compared to current cy elements.
       - Add new elements via `cy.add()`, remove stale elements via `cy.remove()`.
       - Do NOT re-run layout on simple data updates (would reset user's zoom/pan). Only re-layout if new elements were added.

    5. Render the graph legend in `#graph-legend`. Create colored dots for each entity type in ENTITY_COLORS using DOM elements with textContent (XSS-safe):
       ```javascript
       function renderGraphLegend() {
         var legend = document.getElementById('graph-legend');
         if (!legend) return;
         legend.innerHTML = '';  // Safe -- no user data
         Object.keys(ENTITY_COLORS).forEach(function(type) {
           var item = document.createElement('span');
           item.style.cssText = 'display:inline-flex;align-items:center;gap:4px;margin-right:12px;font-size:0.8rem;';
           var dot = document.createElement('span');
           dot.style.cssText = 'width:10px;height:10px;border-radius:50%;display:inline-block;background:' + ENTITY_COLORS[type];
           var label = document.createElement('span');
           label.textContent = type;
           item.appendChild(dot);
           item.appendChild(label);
           legend.appendChild(item);
         });
       }
       ```
       Call `renderGraphLegend()` inside `initGraphVis()` after creating the cytoscape instance.

    6. In the existing `renderGraph()` function (or wherever graph data is refreshed after a poll), add: if graph visual view is currently active, call `updateGraphData()`.
  </action>
  <verify>
    - `grep 'cytoscape(' src/dashboard/public/app.js` returns instance creation
    - `grep 'ENTITY_COLORS' src/dashboard/public/app.js` returns color map definition
    - `grep 'buildGraphStyles' src/dashboard/public/app.js` returns full implementation (not empty array stub)
    - `grep 'expandedNodes' src/dashboard/public/app.js` returns neighbor expansion tracking
    - `grep 'renderGraphLegend' src/dashboard/public/app.js` returns legend rendering function
    - `npm run build` succeeds
    - `npm test` passes with zero regressions
  </verify>
  <done>Graph visualization renders entities as color-coded nodes in a force-directed layout with zoom/pan, click-to-inspect populating the detail panel, and click-to-expand showing connected neighbors.</done>
</task>

<task type="auto">
  <name>Task 2: Polish graph styles and verify dark mode integration</name>
  <files>
    src/dashboard/public/style.css
    src/dashboard/public/app.js
  </files>
  <action>
    1. Verify graph legend styles in style.css. The legend should display as a horizontal flex-wrap list below the graph canvas:
       ```css
       .graph-legend {
         display: flex;
         flex-wrap: wrap;
         gap: 0.5rem;
         padding: 0.5rem;
         color: var(--text);
         font-size: 0.8rem;
       }
       ```
       If not already present from Plan 10-01, add this.

    2. Test dark mode toggle while graph is visible. Verify that `toggleTheme()` calls `window.cyInstance.style(buildGraphStyles())` -- this should already be wired from Plan 10-01. If the graph doesn't update on theme toggle, check that:
       - `buildGraphStyles()` reads the current data-theme attribute at call time (not cached)
       - The cy.style() call uses the return value of buildGraphStyles()
       - Edge colors and label colors adapt to dark/light

    3. Verify that the graph legend colors stay readable in dark mode. Since legend uses inline styles for dot colors (which are constant per entity type) and textContent for labels that inherit `color: var(--text)`, this should work automatically.

    4. Add an empty-state message for when there are no graph entities. In `initGraphVis()`, if `state.graph.data.length === 0`, show a message like "No graph entities yet" in the graph canvas container instead of initializing an empty cytoscape instance.

    5. Ensure that when the user switches back from Visual to Table view in the Graph tab, the table still renders correctly. The `toggleView` function hides the visual container and shows the table container -- verify no state leakage.

    6. Run the full test suite and build to verify no regressions.
  </action>
  <verify>
    - Open dashboard, switch to Graph tab, click "Visual" toggle
    - Nodes appear as colored circles with labels; edges show relationship types
    - Zoom with scroll wheel; pan by dragging background
    - Click a node -- detail panel shows entity details
    - Click a node -- connected nodes expand from existing relation data
    - Toggle dark mode -- graph node labels, edge colors, and legend text update
    - Toggle back to Table view -- table still works normally
    - `npm run build` succeeds
    - `npm test` passes with zero regressions
  </verify>
  <done>Graph visualization is polished with correct dark mode support, readable legend, empty-state handling, and no regressions when switching between Table and Visual views.</done>
</task>

</tasks>

<verification>
1. Graph tab Visual view shows force-directed graph of entities
2. Nodes are color-coded by type (8 distinct colors matching legend)
3. Legend shows all entity types with colored dots
4. Zoom with mouse wheel works; pan by dragging works
5. Click node -- detail panel shows entity properties and relations
6. Click node -- neighbors expand into the graph from existing relation data
7. Toggle dark mode -- graph updates (edge colors, label colors, background)
8. Switch between Table and Visual views -- both work correctly
9. `npm run build` succeeds
10. `npm test` passes with zero regressions
</verification>

<success_criteria>
- Force-directed graph visualization renders from /api/graph data
- Zoom, pan, and click interactions work
- Entity type color-coding with visible legend
- Click-to-expand shows connected neighbors
- Dark mode compatible via buildGraphStyles() refresh
- No regressions
</success_criteria>

<output>
After completion, create `.planning/phases/10-visualizations-and-polish/10-03-SUMMARY.md`
</output>
