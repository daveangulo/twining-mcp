---
phase: 14-agent-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/dashboard/api-routes.ts
  - test/dashboard/api-routes.test.ts
autonomous: true
requirements:
  - DASH-01
  - DASH-02
  - DASH-03

must_haves:
  truths:
    - "GET /api/agents returns agent records with liveness status"
    - "GET /api/delegations returns delegation needs with scored agent suggestions"
    - "GET /api/handoffs returns handoff index entries with acknowledgment status"
    - "GET /api/handoffs/:id returns full handoff record with context snapshot"
    - "GET /api/status includes registered_agents, active_agents, pending_delegations, total_handoffs counts"
    - "All new endpoints return initialized:false with empty arrays when .twining/ does not exist"
  artifacts:
    - path: "src/dashboard/api-routes.ts"
      provides: "4 new API routes for agent coordination data"
      contains: "/api/agents"
    - path: "test/dashboard/api-routes.test.ts"
      provides: "Tests for all new API endpoints"
      contains: "/api/agents"
  key_links:
    - from: "src/dashboard/api-routes.ts"
      to: "src/storage/agent-store.ts"
      via: "AgentStore import and instantiation in closure"
      pattern: "new AgentStore"
    - from: "src/dashboard/api-routes.ts"
      to: "src/storage/handoff-store.ts"
      via: "HandoffStore import and instantiation in closure"
      pattern: "new HandoffStore"
    - from: "src/dashboard/api-routes.ts"
      to: "src/engine/coordination.ts"
      via: "scoreAgent, parseDelegationMetadata, isDelegationExpired pure function imports"
      pattern: "scoreAgent"
    - from: "src/dashboard/api-routes.ts"
      to: "src/utils/liveness.ts"
      via: "computeLiveness and DEFAULT_LIVENESS_THRESHOLDS imports"
      pattern: "computeLiveness"
---

<objective>
Add 4 API endpoints for agent coordination data and extend /api/status with coordination counts.

Purpose: Provide the backend data layer that the frontend Agents tab will consume.
Output: `/api/agents`, `/api/delegations`, `/api/handoffs`, `/api/handoffs/:id` endpoints + extended `/api/status` + tests for all.
</objective>

<execution_context>
@/Users/dave/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dave/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-agent-dashboard/14-RESEARCH.md
@src/dashboard/api-routes.ts
@test/dashboard/api-routes.test.ts
@src/engine/coordination.ts
@src/storage/agent-store.ts
@src/storage/handoff-store.ts
@src/utils/liveness.ts
@src/utils/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add API endpoints for agents, delegations, handoffs, and handoff detail</name>
  <files>src/dashboard/api-routes.ts</files>
  <action>
Add imports at the top of api-routes.ts:
- `import { AgentStore } from "../storage/agent-store.js";`
- `import { HandoffStore } from "../storage/handoff-store.js";`
- `import { scoreAgent, parseDelegationMetadata, isDelegationExpired } from "../engine/coordination.js";`
- `import { computeLiveness, DEFAULT_LIVENESS_THRESHOLDS } from "../utils/liveness.js";`

Inside the `createApiHandler` closure, instantiate new stores alongside existing ones:
```typescript
const agentStore = new AgentStore(twiningDir);
const handoffStore = new HandoffStore(twiningDir);
```

Add 4 new route handlers BEFORE the final `return false` (and before the graph route to keep `/api/handoffs/:id` before `/api/handoffs`):

**1. GET /api/agents** (DASH-01):
- Guard: `if (!fs.existsSync(twiningDir))` return `{ initialized: false, agents: [], total: 0 }`
- Read all agents via `agentStore.getAll()`
- Map each agent to include `liveness: computeLiveness(agent.last_active, new Date(), DEFAULT_LIVENESS_THRESHOLDS)`
- Return `{ initialized: true, agents: mapped, total: mapped.length }`

**2. GET /api/delegations** (DASH-02):
- Guard: `if (!fs.existsSync(twiningDir))` return `{ initialized: false, delegations: [], total: 0 }`
- Read blackboard entries with `entry_types: ["need"]` via `blackboardStore.read({ entry_types: ["need"] })`
- Read all agents via `agentStore.getAll()`
- For each entry, call `parseDelegationMetadata(entry)`. Skip if null (not a delegation).
- Compute `expired = isDelegationExpired(meta, new Date())`
- Score agents against `meta.required_capabilities` using `scoreAgent(agent, meta.required_capabilities, DEFAULT_LIVENESS_THRESHOLDS, new Date())`. Filter to liveness !== "gone", sort by total_score desc, take top 5.
- Build delegation object: `{ entry_id, timestamp, summary, scope, agent_id, required_capabilities, urgency, expires_at, expired, suggested_agents }`
- Return `{ initialized: true, delegations, total: delegations.length }`

**3. GET /api/handoffs/:id** (must come before /api/handoffs exact match) (DASH-03):
- Guard: `if (!fs.existsSync(twiningDir))` return 404 `{ error: "Handoff not found" }`
- Extract id from URL: `url.slice("/api/handoffs/".length)`
- If no id: return 400 `{ error: "Handoff ID required" }`
- Call `handoffStore.get(id)`. If null: return 404 `{ error: "Handoff not found" }`
- Return the full handoff record

**4. GET /api/handoffs** (DASH-03):
- Guard: `if (!fs.existsSync(twiningDir))` return `{ initialized: false, handoffs: [], total: 0 }`
- Read index via `handoffStore.list({})`
- Return `{ initialized: true, handoffs: entries, total: entries.length }`

Also extend **GET /api/status** to include coordination counts:
- After existing code (before `sendJSON`), add:
  - Read agents via `agentStore.getAll()`, compute `registered_agents = agents.length`, `active_agents = agents.filter(a => computeLiveness(a.last_active, new Date(), DEFAULT_LIVENESS_THRESHOLDS) === "active").length`
  - Read blackboard needs, filter delegation entries (those where `parseDelegationMetadata` returns non-null and `isDelegationExpired` is false), compute `pending_delegations` count
  - Read handoffs via `handoffStore.list({})`, compute `total_handoffs = handoffs.length`
- Include `registered_agents`, `active_agents`, `pending_delegations`, `total_handoffs` in the status response (both initialized and uninitialized branches -- zeros for uninitialized)

CRITICAL: All route handlers MUST be wrapped in try/catch with `console.error("[twining] API ...error:", err)` and `sendJSON(res, { error: "Internal server error" }, 500)`. NEVER use console.log.
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compiles without errors.</verify>
  <done>api-routes.ts has 4 new route handlers and extended /api/status, all with proper guards and error handling.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for all new API endpoints</name>
  <files>test/dashboard/api-routes.test.ts</files>
  <action>
Extend the existing test file with test data and new test suites.

**Update `createTestProject()`** to also create agent and handoff data:
- Create `.twining/agents/` directory
- Write `.twining/agents/registry.json` with 2 agent records:
  ```json
  [
    { "agent_id": "agent-alpha", "capabilities": ["typescript", "testing"], "role": "developer", "description": "Alpha agent", "registered_at": "2026-02-17T08:00:00.000Z", "last_active": new Date().toISOString() },
    { "agent_id": "agent-beta", "capabilities": ["python", "data"], "role": "analyst", "registered_at": "2026-02-17T09:00:00.000Z", "last_active": "2025-01-01T00:00:00.000Z" }
  ]
  ```
  (agent-alpha is active, agent-beta is gone due to old last_active)

- Create `.twining/handoffs/` directory
- Write a handoff file `.twining/handoffs/HND001.json`:
  ```json
  { "id": "HND001", "created_at": "2026-02-17T10:00:00.000Z", "source_agent": "agent-alpha", "target_agent": "agent-beta", "scope": "src/", "summary": "Hand off testing work", "results": [{ "task": "Write tests", "status": "completed", "output": "All tests pass" }], "context_snapshot": { "decision_ids": ["DEC001"], "warning_ids": [], "finding_ids": [], "summaries": ["Use embedded HTTP server"] }, "acknowledged_by": null, "acknowledged_at": null }
  ```
- Write handoff index `.twining/handoffs/index.jsonl`:
  ```
  {"id":"HND001","created_at":"2026-02-17T10:00:00.000Z","source_agent":"agent-alpha","target_agent":"agent-beta","scope":"src/","summary":"Hand off testing work","result_status":"completed","acknowledged":false}
  ```

- Add a delegation entry to the existing blackboard entries (BB004):
  ```json
  { "id": "BB004", "timestamp": "2026-02-17T13:00:00.000Z", "agent_id": "agent-alpha", "entry_type": "need", "tags": ["delegation"], "scope": "src/api/", "summary": "Need typescript expert", "detail": "{\"type\":\"delegation\",\"required_capabilities\":[\"typescript\"],\"urgency\":\"normal\",\"expires_at\":\"2099-12-31T23:59:59.000Z\"}" }
  ```

**Add tests in the "initialized project" describe block:**

1. `GET /api/agents returns agents with liveness`: Assert status 200, `body.initialized === true`, `body.agents` has 2 entries, each has `agent_id`, `capabilities`, `liveness`. Verify agent-alpha has liveness "active", agent-beta has liveness "gone".

2. `GET /api/delegations returns delegation needs with scored agents`: Assert status 200, `body.initialized === true`, `body.delegations` has at least 1 entry, each has `entry_id`, `required_capabilities`, `urgency`, `expired`, `suggested_agents` array. Verify `expired === false` for the test delegation (expires 2099).

3. `GET /api/handoffs returns handoff index entries`: Assert status 200, `body.initialized === true`, `body.handoffs` has 1 entry with `id`, `source_agent`, `target_agent`, `result_status`, `acknowledged`.

4. `GET /api/handoffs/:id returns full handoff record`: Assert status 200, body has `id === "HND001"`, `results` array, `context_snapshot` object with `decision_ids`.

5. `GET /api/handoffs/:id returns 404 for unknown ID`: Assert status 404, `body.error === "Handoff not found"`.

6. `GET /api/status includes coordination counts`: Assert `body.registered_agents === 2`, `body.active_agents >= 1`, `typeof body.pending_delegations === "number"`, `body.total_handoffs === 1`.

**Add tests in the "uninitialized project" describe block:**

7. `GET /api/agents returns initialized:false with empty agents`: Assert `body.initialized === false`, `body.agents` is empty array, `body.total === 0`.

8. `GET /api/delegations returns initialized:false with empty delegations`: Assert `body.initialized === false`, `body.delegations` is empty array, `body.total === 0`.

9. `GET /api/handoffs returns initialized:false with empty handoffs`: Assert `body.initialized === false`, `body.handoffs` is empty array, `body.total === 0`.

10. `GET /api/handoffs/:id returns 404 when uninitialized`: Assert status 404, `body.error === "Handoff not found"`.

11. `GET /api/status includes zero coordination counts when uninitialized`: Assert `body.registered_agents === 0`, `body.active_agents === 0`, `body.pending_delegations === 0`, `body.total_handoffs === 0`.
  </action>
  <verify>Run `npx vitest run test/dashboard/api-routes.test.ts` and verify all tests pass (both existing and new).</verify>
  <done>All new API endpoint tests pass alongside existing tests. Both initialized and uninitialized scenarios covered.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — TypeScript compiles without errors
2. `npx vitest run test/dashboard/api-routes.test.ts` — all tests pass
3. `npx vitest run` — full test suite passes (no regressions)
</verification>

<success_criteria>
- 4 new API endpoints serve correct JSON for agents, delegations, handoffs, handoff detail
- /api/status response includes coordination counts
- All endpoints handle uninitialized projects gracefully
- Tests cover both initialized and uninitialized scenarios
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/14-agent-dashboard/14-01-SUMMARY.md`
</output>
