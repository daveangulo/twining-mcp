---
phase: 14-agent-dashboard
plan: 02
type: execute
wave: 2
depends_on:
  - 14-01
files_modified:
  - src/dashboard/public/index.html
  - src/dashboard/public/style.css
  - src/dashboard/public/app.js
autonomous: true
requirements:
  - DASH-01
  - DASH-02
  - DASH-03

must_haves:
  truths:
    - "Dashboard has an Agents tab with sub-views for Agents, Delegations, and Handoffs"
    - "Agents sub-view shows agent table with liveness badges, capabilities, role, last active time"
    - "Delegations sub-view shows delegation needs with urgency badges, expiry status, and scored agent suggestions"
    - "Handoffs sub-view shows handoff history with result status badges and acknowledgment indicator"
    - "Clicking a handoff shows full detail including context snapshot and results"
    - "Stats tab shows coordination counts (registered agents, active agents, pending delegations, total handoffs)"
    - "All new views support sorting, pagination, global scope filtering, and dark mode"
  artifacts:
    - path: "src/dashboard/public/index.html"
      provides: "Agents tab with 3 sub-view sections and view-toggle buttons"
      contains: "tab-agents"
    - path: "src/dashboard/public/style.css"
      provides: "Liveness, urgency, result status badge styles with dark mode"
      contains: "liveness-active"
    - path: "src/dashboard/public/app.js"
      provides: "Fetch, render, and state management for agents/delegations/handoffs views"
      contains: "fetchAgents"
  key_links:
    - from: "src/dashboard/public/app.js"
      to: "/api/agents"
      via: "fetch in fetchAgents()"
      pattern: "fetch.*api/agents"
    - from: "src/dashboard/public/app.js"
      to: "/api/delegations"
      via: "fetch in fetchDelegations()"
      pattern: "fetch.*api/delegations"
    - from: "src/dashboard/public/app.js"
      to: "/api/handoffs"
      via: "fetch in fetchHandoffs()"
      pattern: "fetch.*api/handoffs"
    - from: "src/dashboard/public/app.js"
      to: "/api/handoffs/:id"
      via: "fetch in fetchHandoffDetail()"
      pattern: "fetch.*api/handoffs/"
---

<objective>
Add the Agents tab to the dashboard frontend with three sub-views (Agents, Delegations, Handoffs) and extend Stats with coordination counts.

Purpose: Make agent coordination state visible and browsable in the web dashboard.
Output: Fully functional Agents tab with sortable tables, detail panels, liveness/urgency/status badges, and dark mode support.
</objective>

<execution_context>
@/Users/dave/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dave/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-agent-dashboard/14-RESEARCH.md
@.planning/phases/14-agent-dashboard/14-01-SUMMARY.md
@src/dashboard/public/index.html
@src/dashboard/public/style.css
@src/dashboard/public/app.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Agents tab HTML structure and CSS styles</name>
  <files>src/dashboard/public/index.html, src/dashboard/public/style.css</files>
  <action>
**index.html changes:**

1. Add a new tab button in the `<nav class="tabs">` section, after the Search button:
```html
<button class="tab-btn" data-tab="agents">Agents</button>
```

2. Add 4 new stat cards to the stats-grid (after the existing "Last Activity" card, before `uninitialized-msg`):
```html
<div class="stat-card">
  <div class="stat-label">Registered Agents</div>
  <div class="stat-value" id="stat-registered-agents">--</div>
</div>
<div class="stat-card">
  <div class="stat-label">Active Agents</div>
  <div class="stat-value" id="stat-active-agents">--</div>
</div>
<div class="stat-card">
  <div class="stat-label">Pending Delegations</div>
  <div class="stat-value" id="stat-pending-delegations">--</div>
</div>
<div class="stat-card">
  <div class="stat-label">Total Handoffs</div>
  <div class="stat-value" id="stat-total-handoffs">--</div>
</div>
```

3. Add Agents tab content section (after the Search tab `</div>`, before `</main>`). Use the same view-toggle pattern as Decisions/Graph tabs, with Agents/Delegations/Handoffs sub-views:

```html
<!-- Agents Tab -->
<div class="tab-content" id="tab-agents" style="display:none">
  <div class="view-toggle" id="agents-view-toggle">
    <button class="view-btn active" data-view="agents-list" data-tab="agents">Agents</button>
    <button class="view-btn" data-view="delegations" data-tab="agents">Delegations</button>
    <button class="view-btn" data-view="handoffs" data-tab="agents">Handoffs</button>
  </div>

  <!-- Agents List Sub-view -->
  <div class="view-table" id="agents-list-view">
    <div class="content-area">
      <div class="list-panel">
        <table class="data-table" id="agents-table">
          <thead>
            <tr>
              <th class="sortable-header" data-sort-key="agent_id">Agent ID</th>
              <th class="sortable-header" data-sort-key="liveness">Status</th>
              <th class="sortable-header" data-sort-key="role">Role</th>
              <th>Capabilities</th>
              <th class="sortable-header" data-sort-key="last_active">Last Active</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="pagination" id="agents-pagination"></div>
      </div>
      <div class="detail-panel" id="agents-detail">
        <p class="placeholder">Select an agent to view details</p>
      </div>
    </div>
  </div>

  <!-- Delegations Sub-view -->
  <div class="view-visual" id="delegations-view" style="display:none">
    <div class="content-area">
      <div class="list-panel">
        <table class="data-table" id="delegations-table">
          <thead>
            <tr>
              <th class="sortable-header" data-sort-key="timestamp">Timestamp</th>
              <th class="sortable-header" data-sort-key="urgency">Urgency</th>
              <th class="sortable-header" data-sort-key="summary">Summary</th>
              <th>Required Capabilities</th>
              <th class="sortable-header" data-sort-key="expired">Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="pagination" id="delegations-pagination"></div>
      </div>
      <div class="detail-panel" id="delegations-detail">
        <p class="placeholder">Select a delegation to view details</p>
      </div>
    </div>
  </div>

  <!-- Handoffs Sub-view -->
  <div class="view-visual" id="handoffs-view" style="display:none">
    <div class="content-area">
      <div class="list-panel">
        <table class="data-table" id="handoffs-table">
          <thead>
            <tr>
              <th class="sortable-header" data-sort-key="created_at">Created</th>
              <th class="sortable-header" data-sort-key="source_agent">Source</th>
              <th class="sortable-header" data-sort-key="target_agent">Target</th>
              <th class="sortable-header" data-sort-key="summary">Summary</th>
              <th class="sortable-header" data-sort-key="result_status">Result</th>
              <th class="sortable-header" data-sort-key="acknowledged">Ack</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="pagination" id="handoffs-pagination"></div>
      </div>
      <div class="detail-panel" id="handoffs-detail">
        <p class="placeholder">Select a handoff to view details</p>
      </div>
    </div>
  </div>
</div>
```

**style.css changes:**

Add liveness badge styles (after existing badge styles):

```css
/* Liveness badges */
.badge.active { background: #dcfce7; color: #166534; }
.badge.idle { background: #fef3c7; color: #92400e; }
.badge.gone { background: #fecaca; color: #991b1b; }

[data-theme="dark"] .badge.active { background: #064e3b; color: #a7f3d0; }
[data-theme="dark"] .badge.idle { background: #451a03; color: #fde68a; }
[data-theme="dark"] .badge.gone { background: #450a0a; color: #fecaca; }

/* Urgency badges */
.badge.high { background: #fecaca; color: #991b1b; }
.badge.normal { background: #dbeafe; color: #1e40af; }
.badge.low { background: #e2e8f0; color: #475569; }

[data-theme="dark"] .badge.high { background: #450a0a; color: #fecaca; }
[data-theme="dark"] .badge.normal { background: #1e3a5f; color: #93c5fd; }
[data-theme="dark"] .badge.low { background: #334155; color: #94a3b8; }

/* Result status badges */
.badge.completed { background: #dcfce7; color: #166534; }
.badge.partial { background: #fef3c7; color: #92400e; }
.badge.blocked { background: #fecaca; color: #991b1b; }
.badge.failed { background: #fecaca; color: #991b1b; }
.badge.mixed { background: #e0e7ff; color: #3730a3; }

[data-theme="dark"] .badge.completed { background: #064e3b; color: #a7f3d0; }
[data-theme="dark"] .badge.partial { background: #451a03; color: #fde68a; }
[data-theme="dark"] .badge.blocked { background: #450a0a; color: #fecaca; }
[data-theme="dark"] .badge.failed { background: #450a0a; color: #fecaca; }
[data-theme="dark"] .badge.mixed { background: #312e81; color: #c7d2fe; }

/* Expired delegation visual distinction */
tr.delegation-expired { opacity: 0.6; }
tr.delegation-expired td { text-decoration: line-through; }

/* Capability tags */
.capability-tag {
  display: inline-block;
  padding: 0.125rem 0.375rem;
  margin: 0.125rem;
  border-radius: 0.25rem;
  font-size: 0.75rem;
  background: var(--card-border);
  color: var(--text);
}

/* Acknowledged indicator */
.ack-yes { color: #166534; }
.ack-no { color: #991b1b; font-style: italic; }
[data-theme="dark"] .ack-yes { color: #a7f3d0; }
[data-theme="dark"] .ack-no { color: #fecaca; }

/* Suggested agents list in delegation detail */
.suggested-agent {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.25rem 0;
  border-bottom: 1px solid var(--card-border);
  font-size: 0.875rem;
}
.suggested-agent:last-child { border-bottom: none; }
.agent-score {
  font-weight: 600;
  font-size: 0.75rem;
  padding: 0.125rem 0.375rem;
  border-radius: 0.25rem;
  background: var(--card-border);
}
```

NOTE: Some badge class names like `.badge.active` and `.badge.completed` may conflict with existing status/confidence badges. Check for conflicts. If `.badge.active` already exists for decision status, the liveness badge will inherit those styles which is fine since "active" has similar green semantics. If there is a conflict, namespace with `.badge.liveness-active` etc. and use the namespaced classes in app.js. The research recommends the namespaced approach — use `liveness-active`, `liveness-idle`, `liveness-gone` class names in CSS and app.js to avoid any ambiguity.

**CORRECTION: Use namespaced badge classes to avoid conflicts:**
- Liveness: `.badge.liveness-active`, `.badge.liveness-idle`, `.badge.liveness-gone`
- Urgency: `.badge.urgency-high`, `.badge.urgency-normal`, `.badge.urgency-low`
- Result: `.badge.result-completed`, `.badge.result-partial`, `.badge.result-blocked`, `.badge.result-failed`, `.badge.result-mixed`

Update all CSS class names and app.js badge creation accordingly.
  </action>
  <verify>Open index.html in browser, verify new tab button appears, clicking it shows sub-view toggles.</verify>
  <done>HTML has Agents tab with 3 sub-views and stat cards. CSS has liveness, urgency, result status badge styles with dark mode variants.</done>
</task>

<task type="auto">
  <name>Task 2: Add frontend JavaScript for agents/delegations/handoffs views</name>
  <files>src/dashboard/public/app.js</files>
  <action>
Add state, fetch, render, and detail functions for all three sub-views, following the exact same patterns as existing tabs.

**1. State additions** (add to the `state` object):
```javascript
agents: { data: [], sortKey: "agent_id", sortDir: "asc", page: 1, pageSize: 25, selectedId: null },
delegations: { data: [], sortKey: "timestamp", sortDir: "desc", page: 1, pageSize: 25, selectedId: null },
handoffs: { data: [], sortKey: "created_at", sortDir: "desc", page: 1, pageSize: 25, selectedId: null },
agentsSubView: "agents-list",
```

**2. Fetch functions** (add after fetchGraph, same pattern as fetchBlackboard):

`fetchAgents()`: Fetch `/api/agents`, store `data.agents || []` in `state.agents.data`, call `renderAgents()`.

`fetchDelegations()`: Fetch `/api/delegations`, store `data.delegations || []` in `state.delegations.data`, call `renderDelegations()`.

`fetchHandoffs()`: Fetch `/api/handoffs`, store `data.handoffs || []` in `state.handoffs.data`, call `renderHandoffs()`.

`fetchHandoffDetail(id)`: Fetch `/api/handoffs/${encodeURIComponent(id)}`, on 404 show "Handoff not found", on success call `renderHandoffDetail(data)`. Same pattern as `fetchDecisionDetail`.

**3. Render functions:**

`renderAgents()`: Same table rendering pattern as renderBlackboard.
- Apply `applyGlobalScope` (scope field is not present on agents — skip scope filtering since agents don't have a scope field, OR filter on capabilities/role if desired. Actually: agents don't have scope. Just sort and paginate without scope filter.)
- Note: agents don't have a `scope` field so applyGlobalScope should be skipped for agents. Just sort and paginate directly.
- Table columns: Agent ID (text), Status (createBadge with `"liveness-" + agent.liveness`), Role (text), Capabilities (render each as `.capability-tag` span), Last Active (formatTimestamp).
- On row click: set selectedId to agent.agent_id, call renderAgentDetail(agent).
- Use updateSortHeaders("agents-table", ...) and renderPagination("agents-pagination", ...).

`renderAgentDetail(agent)`: Detail panel in `#agents-detail`.
- Fields: Agent ID, Role, Description, Registered At, Last Active, Liveness (badge)
- Capabilities as tag badges

`renderDelegations()`: Same table rendering pattern.
- Columns: Timestamp, Urgency (createBadge with `"urgency-" + del.urgency`), Summary (truncated), Required Capabilities (as capability-tag spans), Status (show "Expired" badge if expired, "Active" badge if not).
- Expired rows get class `delegation-expired`.
- On row click: set selectedId, call renderDelegationDetail(delegation).
- Use updateSortHeaders("delegations-table", ...) and renderPagination("delegations-pagination", ...).

`renderDelegationDetail(delegation)`: Detail panel in `#delegations-detail`.
- Fields: Entry ID (clickable), Timestamp, Summary, Scope, Agent ID, Urgency (badge), Required Capabilities (tags), Expires At, Status (expired badge)
- Suggested Agents section: render each as `.suggested-agent` div with agent_id, liveness badge, score percentage.

`renderHandoffs()`: Same table rendering pattern.
- Columns: Created (formatTimestamp), Source (text), Target (text or "--"), Summary (truncated), Result (createBadge with `"result-" + handoff.result_status`), Ack (checkmark or "No" with ack-yes/ack-no class).
- On row click: set selectedId, call fetchHandoffDetail(id).
- Use updateSortHeaders("handoffs-table", ...) and renderPagination("handoffs-pagination", ...).

`renderHandoffDetail(handoff)`: Detail panel in `#handoffs-detail`.
- Fields: ID (clickable), Created At, Source Agent, Target Agent, Scope, Summary, Result Status (badge), Acknowledged (yes/no with who and when)
- Results section: for each result, show task, status (badge), output text
- Context Snapshot: show decision_ids (clickable), warning_ids (clickable), finding_ids (clickable), summaries list

**4. Update refreshData():**
Add `else if (tab === "agents")` case that calls the appropriate fetch based on `state.agentsSubView`:
- `"agents-list"` -> `fetchAgents()`
- `"delegations"` -> `fetchDelegations()`
- `"handoffs"` -> `fetchHandoffs()`

**5. Update switchTab():**
Add `if (tabName === "agents" && state.agents.data.length === 0) fetchAgents();` for initial load.

**6. Update toggleView():**
Add agents tab handling:
```javascript
if (tab === 'agents') {
  document.getElementById('agents-list-view').style.display = viewName === 'agents-list' ? 'block' : 'none';
  document.getElementById('delegations-view').style.display = viewName === 'delegations' ? 'block' : 'none';
  document.getElementById('handoffs-view').style.display = viewName === 'handoffs' ? 'block' : 'none';
  state.agentsSubView = viewName;
  // Fetch data for the sub-view if needed
  if (viewName === 'agents-list' && state.agents.data.length === 0) fetchAgents();
  if (viewName === 'delegations' && state.delegations.data.length === 0) fetchDelegations();
  if (viewName === 'handoffs' && state.handoffs.data.length === 0) fetchHandoffs();
}
```

**7. Update handleSort():**
Add cases for `"agents"`, `"delegations"`, `"handoffs"` that call the corresponding render function.

**8. Update renderStatus():**
Add stat card value updates:
```javascript
setVal("stat-registered-agents", s.registered_agents);
setVal("stat-active-agents", s.active_agents);
setVal("stat-pending-delegations", s.pending_delegations);
setVal("stat-total-handoffs", s.total_handoffs);
```

**9. Update sort header click handler in DOMContentLoaded:**
Add table-to-tab mappings:
```javascript
else if (tableId === "agents-table") tabName = "agents";
else if (tableId === "delegations-table") tabName = "delegations";
else if (tableId === "handoffs-table") tabName = "handoffs";
```

**10. Update global scope filter reset:**
Add `state.agents.page = 1; state.delegations.page = 1; state.handoffs.page = 1;` to the scope change handler.

**IMPORTANT:** All user-provided content must use `textContent`, never `innerHTML`. Follow existing XSS-safe patterns exactly.
  </action>
  <verify>Build with `npm run build`. Open dashboard in browser, navigate to Agents tab, verify all three sub-views render correctly with data from the API.</verify>
  <done>Dashboard Agents tab has 3 working sub-views with sortable tables, detail panels, badges, pagination, scope filtering, dark mode support, and polling.</done>
</task>

</tasks>

<verification>
1. `npm run build` — builds without errors (TS compiles, assets copied)
2. Open dashboard at http://localhost:24282
3. Stats tab shows coordination counts (Registered Agents, Active Agents, Pending Delegations, Total Handoffs)
4. Agents tab visible with Agents/Delegations/Handoffs sub-view toggles
5. Agents sub-view shows sortable table with liveness badges, capabilities, and detail panel
6. Delegations sub-view shows delegation needs with urgency badges, scored agent suggestions
7. Handoffs sub-view shows handoff history with result status and acknowledgment
8. Clicking a handoff shows full detail with context snapshot and results
9. Dark mode toggle works for all new badge styles
10. Global scope filter affects delegation display (if scope applies)
</verification>

<success_criteria>
- Dashboard has 6 tabs (Stats, Blackboard, Decisions, Graph, Search, Agents)
- Agents tab has 3 sub-views matching the existing toggle pattern
- All agent, delegation, and handoff data is visible and browsable
- Liveness, urgency, and result status badges have correct colors in both light and dark mode
- Clicking handoffs shows full detail with context snapshot
- Stats tab includes coordination counts
- All data renders via textContent (XSS safe)
</success_criteria>

<output>
After completion, create `.planning/phases/14-agent-dashboard/14-02-SUMMARY.md`
</output>
