---
phase: 12-coordination-engine
plan: 03
type: tdd
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/engine/coordination.ts
  - test/coordination-engine.test.ts
autonomous: true
requirements: [HND-01, HND-02, HND-04]

must_haves:
  truths:
    - "createHandoff() creates a handoff record with results via HandoffStore.create()"
    - "Context snapshot is auto-assembled from active decisions and warnings/findings in scope when auto_snapshot is true"
    - "Context snapshot includes decision IDs, warning IDs, finding IDs, and short summaries"
    - "Manual context_snapshot overrides auto-assembly"
    - "auto_snapshot=false produces empty context snapshot"
    - "A blackboard status entry is posted on handoff creation for visibility"
    - "acknowledgeHandoff() delegates to HandoffStore.acknowledge()"
  artifacts:
    - path: "src/engine/coordination.ts"
      provides: "createHandoff and acknowledgeHandoff methods, assembleContextSnapshot private method"
      contains: "assembleContextSnapshot"
    - path: "test/coordination-engine.test.ts"
      provides: "Tests for handoff creation, context snapshot, and acknowledgment"
      min_lines: 200
  key_links:
    - from: "src/engine/coordination.ts"
      to: "src/storage/handoff-store.ts"
      via: "HandoffStore.create() and HandoffStore.acknowledge() in createHandoff/acknowledgeHandoff"
      pattern: "handoffStore\\.(create|acknowledge)"
    - from: "src/engine/coordination.ts"
      to: "src/storage/decision-store.ts"
      via: "DecisionStore.getIndex() in assembleContextSnapshot"
      pattern: "decisionStore\\.getIndex"
    - from: "src/engine/coordination.ts"
      to: "src/storage/blackboard-store.ts"
      via: "BlackboardStore.read() in assembleContextSnapshot for warnings/findings"
      pattern: "blackboardStore\\.read"
    - from: "src/engine/coordination.ts"
      to: "src/engine/blackboard.ts"
      via: "BlackboardEngine.post() for status entry on handoff creation"
      pattern: "blackboardEngine\\.post.*status"
---

<objective>
Implement handoff creation with auto-assembled context snapshots and acknowledgment.

Purpose: Enable agents to create structured handoff records that capture results and relevant context (decisions, warnings, findings) so the receiving agent has full awareness of the current state. This closes the coordination loop -- agents can delegate, do work, and hand off results with context.

Output: createHandoff() and acknowledgeHandoff() methods on CoordinationEngine, assembleContextSnapshot private method
</objective>

<execution_context>
@/Users/dave/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dave/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-coordination-engine/12-RESEARCH.md
@.planning/phases/12-coordination-engine/12-01-SUMMARY.md
@src/engine/coordination.ts
@src/storage/handoff-store.ts
@src/storage/decision-store.ts
@src/storage/blackboard-store.ts
@src/engine/blackboard.ts
@src/utils/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED - Write failing tests for createHandoff, acknowledgeHandoff, and context snapshot assembly</name>
  <files>test/coordination-engine.test.ts</files>
  <action>
Add failing tests to `test/coordination-engine.test.ts` in new describe blocks. Use the existing engine/store instances from beforeEach.

**Helper setup for handoff tests:** In the relevant describe block's beforeEach or in individual tests, seed test data:
- Create a few decisions via `decisionStore.save()` with different scopes (e.g., "src/auth/", "src/api/", "project")
- Post some warning and finding entries via `blackboardStore.append()` with different scopes

Tests for `assembleContextSnapshot` (tested indirectly via createHandoff with auto_snapshot=true):
1. Auto-snapshot collects decision IDs for matching scope (bidirectional prefix: handoff scope "src/" matches decision scope "src/auth/")
2. Auto-snapshot collects warning IDs and finding IDs from blackboard for matching scope
3. Auto-snapshot includes summaries (up to 5 decisions, 3 warnings, 3 findings)
4. Auto-snapshot with no matching scope returns empty arrays
5. Auto-snapshot with no scope (undefined) collects all active decisions and warnings/findings

Tests for `createHandoff()`:
1. Creates a handoff record with source_agent, summary, and results
2. Returns a HandoffRecord with generated id and created_at
3. Auto-snapshot is the default (context_snapshot populated without explicit opt-in)
4. auto_snapshot=false produces handoff with empty context_snapshot arrays
5. Explicit context_snapshot overrides auto-assembly
6. Posts a blackboard "status" entry with "handoff" tag on creation
7. Status entry summary starts with "Handoff created:" and is truncated to 200 chars
8. Handoff with target_agent specified is persisted correctly
9. Handoff with scope specified filters context snapshot to that scope

Tests for `acknowledgeHandoff()`:
1. Acknowledges a handoff by ID, returns updated record with acknowledged_by and acknowledged_at
2. Returns error/throws for non-existent handoff ID (match HandoffStore behavior)

Run `npx vitest run test/coordination-engine.test.ts` -- new tests MUST fail (RED). Existing tests must still pass.
  </action>
  <verify>Run `npx vitest run test/coordination-engine.test.ts` -- existing scoreAgent/discover tests pass; new handoff tests fail. `npx tsc --noEmit` passes.</verify>
  <done>12+ new failing tests for createHandoff, context snapshot assembly, and acknowledgeHandoff.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN - Implement createHandoff, acknowledgeHandoff, and assembleContextSnapshot</name>
  <files>src/engine/coordination.ts</files>
  <action>
Implement in `src/engine/coordination.ts`:

**assembleContextSnapshot** (private method):
```typescript
private async assembleContextSnapshot(
  scope?: string,
): Promise<HandoffRecord["context_snapshot"]>
```

Logic:
1. Get decision index via `this.decisionStore.getIndex()`
2. Filter to active decisions. If scope provided, use bidirectional prefix matching: `d.scope.startsWith(scope) || scope.startsWith(d.scope)`. If no scope, include all active decisions.
3. Read blackboard entries filtered to warning and finding types via `this.blackboardStore.read({ entry_types: ["warning", "finding"], scope })`
   - Note: BlackboardStore.read() already does scope matching, so pass scope directly
4. Separate warnings and findings from returned entries
5. Build context_snapshot:
   - decision_ids: filtered decision index entries mapped to .id
   - warning_ids: warning entries mapped to .id
   - finding_ids: finding entries mapped to .id
   - summaries: up to 5 decision summaries (`Decision: ${d.summary}`), up to 3 warning summaries (`Warning: ${e.summary}`), up to 3 finding summaries (`Finding: ${e.summary}`)

**createHandoff method**:
```typescript
async createHandoff(input: CreateHandoffInput): Promise<HandoffRecord>
```

Logic:
1. Determine context_snapshot:
   - If `input.context_snapshot` provided, use it directly
   - Else if `input.auto_snapshot !== false`, call `this.assembleContextSnapshot(input.scope)`
   - Else use empty: `{ decision_ids: [], warning_ids: [], finding_ids: [], summaries: [] }`
2. Call `this.handoffStore.create({ source_agent, target_agent, scope, summary, results, context_snapshot })`
3. Post status entry to blackboard:
   - entry_type: "status"
   - summary: `Handoff created: ${input.summary}`.slice(0, 200)
   - detail: `From ${input.source_agent} to ${input.target_agent ?? "any agent"}. ${input.results.length} result(s).`
   - tags: ["handoff"]
   - scope: input.scope ?? "project"
   - agent_id: input.source_agent
4. Return the created HandoffRecord

**acknowledgeHandoff method**:
```typescript
async acknowledgeHandoff(id: string, acknowledgedBy: string): Promise<HandoffRecord>
```

Logic: Delegate directly to `this.handoffStore.acknowledge(id, acknowledgedBy)` and return the result.

Note on DecisionStore.getIndex(): Check the actual method signature. It may be called `getIndex()` or similar -- match the real API from `src/storage/decision-store.ts`.
  </action>
  <verify>Run `npx vitest run test/coordination-engine.test.ts` -- ALL tests pass. Run `npx tsc --noEmit` -- no type errors. Run `npx vitest run` to verify no regressions across the full test suite.</verify>
  <done>All handoff tests pass. createHandoff auto-assembles context snapshots with decisions, warnings, and findings. acknowledgeHandoff works. Full test suite green.</done>
</task>

</tasks>

<verification>
```bash
npx vitest run test/coordination-engine.test.ts
npx tsc --noEmit
npx vitest run
```
All coordination-engine tests pass. No type errors. No regressions in existing test suite.
</verification>

<success_criteria>
- createHandoff() creates a HandoffRecord via HandoffStore with auto-assembled context snapshot
- Context snapshot uses bidirectional prefix matching for scope filtering on decisions
- Context snapshot collects decision IDs, warning IDs, finding IDs, and capped summaries
- Manual context_snapshot overrides auto-assembly; auto_snapshot=false produces empty snapshot
- Blackboard status entry posted on creation for coordination visibility
- acknowledgeHandoff() delegates to HandoffStore.acknowledge()
- All prior tests (scoreAgent, discover, delegation) still pass
</success_criteria>

<output>
After completion, create `.planning/phases/12-coordination-engine/12-03-SUMMARY.md`
</output>
