---
phase: 13-tools-and-assembly
plan: 02
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - src/utils/types.ts
  - src/engine/context-assembler.ts
  - src/server.ts
  - test/context-assembler.test.ts
autonomous: true
requirements: [HND-03, HND-06]

must_haves:
  truths:
    - "twining_assemble includes recent_handoffs in its output when handoffs exist matching the scope"
    - "twining_assemble includes suggested_agents in its output when agents have capabilities matching the task"
    - "Handoff results in assembled context are capped at 5 most recent scope-matching entries"
    - "Agent suggestions are included outside the token budget (like planning_state)"
    - "Context assembly works unchanged when no handoffStore or agentStore is provided"
  artifacts:
    - path: "src/utils/types.ts"
      provides: "Extended AssembledContext with recent_handoffs and suggested_agents fields"
      contains: "recent_handoffs"
    - path: "src/engine/context-assembler.ts"
      provides: "ContextAssembler with HandoffStore + AgentStore optional dependencies"
      contains: "handoffStore"
  key_links:
    - from: "src/engine/context-assembler.ts"
      to: "HandoffStore.list()"
      via: "handoffStore.list({ scope, limit: 5 }) in assemble()"
      pattern: "handoffStore.*list"
    - from: "src/engine/context-assembler.ts"
      to: "AgentStore.getAll()"
      via: "agentStore.getAll() for suggested agents"
      pattern: "agentStore.*getAll"
    - from: "src/server.ts"
      to: "ContextAssembler constructor"
      via: "handoffStore and agentStore passed to ContextAssembler"
      pattern: "new ContextAssembler"
---

<objective>
Extend `ContextAssembler` to include handoff results and agent suggestions in its assembled context output.

Purpose: Make context assembly coordination-aware so agents assembling context for a task can see relevant handoff results from other agents and discover agents with matching capabilities for the current work.

Output: Extended `AssembledContext` type, updated `ContextAssembler` with `HandoffStore` and `AgentStore` optional dependencies, updated `server.ts` wiring, full test coverage.
</objective>

<execution_context>
@/Users/dave/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dave/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-tools-and-assembly/13-01-SUMMARY.md

@src/engine/context-assembler.ts
@src/utils/types.ts
@src/server.ts
@src/storage/handoff-store.ts
@src/storage/agent-store.ts
@src/utils/liveness.ts
@src/utils/tags.ts
@test/context-assembler.test.ts
@.planning/phases/13-tools-and-assembly/13-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend AssembledContext type and add handoff results to context assembly</name>
  <files>src/utils/types.ts, src/engine/context-assembler.ts, test/context-assembler.test.ts</files>
  <action>
**Extend types.ts:**

1. Add two new optional fields to the `AssembledContext` interface:
   ```typescript
   recent_handoffs?: {
     id: string;
     source_agent: string;
     target_agent: string;
     scope: string;
     summary: string;
     result_status: string;
     acknowledged: boolean;
     created_at: string;
   }[];
   suggested_agents?: {
     agent_id: string;
     capabilities: string[];
     liveness: string;
   }[];
   ```

**Extend context-assembler.ts:**

1. Add imports: `HandoffStore` from `../storage/handoff-store.js`, `AgentStore` from `../storage/agent-store.js`, `computeLiveness` from `../utils/liveness.js`, `DEFAULT_LIVENESS_THRESHOLDS` from `../utils/types.js`, `normalizeTags` from `../utils/tags.js`
2. Add private fields: `handoffStore: HandoffStore | null`, `agentStore: AgentStore | null`
3. Extend constructor with two new optional parameters after `planningBridge`:
   - `handoffStore?: HandoffStore | null`
   - `agentStore?: AgentStore | null`
   - Initialize with `this.handoffStore = handoffStore ?? null` and same for agentStore
4. In the `assemble()` method, after the existing `planning_state` section (which is added outside token budget):
   a. **Handoff results (HND-03):** If `this.handoffStore` is not null:
      - Call `this.handoffStore.list({ scope, limit: 5 })` to get up to 5 most recent scope-matching handoffs
      - Map to the `recent_handoffs` shape (id, source_agent, target_agent, scope, summary, result_status, acknowledged, created_at)
      - Add to result as `recent_handoffs` field (outside token budget, like planning_state)
   b. **Agent suggestions (HND-06):** If `this.agentStore` is not null:
      - Call `this.agentStore.getAll()` to get all agents
      - Get liveness thresholds from `this.config.agents?.liveness ?? DEFAULT_LIVENESS_THRESHOLDS`
      - Compute liveness for each agent, filter out gone agents
      - Extract words from the task description using `normalizeTags(task.split(/\s+/))` to get normalized task terms
      - For each non-gone agent, check if any of their capabilities (normalized) appear as a substring of any task term or vice versa (e.g., capability "testing" matches task term "tests")
      - Include agents with any capability match as `suggested_agents` with `{ agent_id, capabilities, liveness }`
      - Add to result outside token budget

**Extend test/context-assembler.test.ts:**

Add a new describe block "handoff and agent integration" with tests:
1. "includes recent handoffs matching scope in assembled context" — create handoff store with entries, assemble with matching scope, verify recent_handoffs populated
2. "caps handoffs at 5" — create 7 handoffs, verify only 5 returned
3. "returns empty recent_handoffs when no handoffs match scope" — assemble for scope with no matches
4. "suggests agents with matching capabilities for task" — register agents with capabilities, assemble with task text matching capabilities, verify suggested_agents
5. "does not suggest gone agents" — register an agent with old last_active, verify not in suggested_agents
6. "works without handoffStore or agentStore (backward compatible)" — assemble without new deps, verify result has no recent_handoffs or suggested_agents fields (or they are undefined)
  </action>
  <verify>Run `npx vitest run test/context-assembler.test.ts` — all tests pass (existing + new).</verify>
  <done>AssembledContext type extended, ContextAssembler queries HandoffStore for recent handoffs and AgentStore for agent suggestions, both included outside token budget, 6+ new tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Wire HandoffStore and AgentStore into ContextAssembler in server.ts</name>
  <files>src/server.ts, test/context-assembler.test.ts</files>
  <action>
**Update server.ts:**

1. The AgentStore, HandoffStore, and CoordinationEngine are already created in server.ts from Plan 13-01.
2. Update the `new ContextAssembler(...)` call to pass `handoffStore` and `agentStore` as the two new optional parameters (after `planningBridge`):
   ```typescript
   const contextAssembler = new ContextAssembler(
     blackboardStore,
     decisionStore,
     searchEngine,
     config,
     graphEngine,
     planningBridge,
     handoffStore,   // NEW: for recent handoffs in assembly
     agentStore,     // NEW: for agent suggestions in assembly
   );
   ```

**Verify backward compatibility:**

Run the full test suite to ensure no regressions. The existing ContextAssembler tests that don't pass handoffStore/agentStore should still work since the params are optional with null defaults.
  </action>
  <verify>Run `npx vitest run` — full suite passes (all 419+ tests, no regressions). Run `npx tsc --noEmit` — no TypeScript errors.</verify>
  <done>server.ts passes HandoffStore and AgentStore to ContextAssembler, full test suite passes, context assembly is now coordination-aware.</done>
</task>

</tasks>

<verification>
1. `npx vitest run` — full test suite passes (425+ tests expected, no regressions)
2. `npx tsc --noEmit` — no TypeScript errors
3. `twining_assemble` output includes `recent_handoffs` when handoffs exist for scope
4. `twining_assemble` output includes `suggested_agents` when agents match task capabilities
5. Both new fields are outside token budget (not counted toward token_estimate)
6. Backward compatible: assembly works fine when stores are not provided
</verification>

<success_criteria>
- twining_assemble includes relevant handoff results in context output (HND-03)
- Context assembly suggests available agents with matching capabilities (HND-06)
- Handoffs capped at 5 most recent scope-matching entries
- Agent suggestions exclude gone agents and use simple tag matching
- All new tests pass, no regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/13-tools-and-assembly/13-02-SUMMARY.md`
</output>
