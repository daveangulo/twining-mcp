---
phase: 06-search-export
plan: 02
type: execute
wave: 2
depends_on:
  - "06-01"
files_modified:
  - src/engine/exporter.ts
  - src/tools/export-tools.ts
  - src/server.ts
  - src/engine/exporter.test.ts
autonomous: true
requirements:
  - XPRT-01
  - XPRT-02

must_haves:
  truths:
    - "Agent can get a single markdown document containing all Twining state"
    - "Export includes blackboard entries, decisions, and graph entities/relations"
    - "Export can be filtered by scope to show only relevant subset"
  artifacts:
    - path: "src/engine/exporter.ts"
      provides: "Exporter class with exportMarkdown() method"
      contains: "class Exporter"
    - path: "src/tools/export-tools.ts"
      provides: "twining_export MCP tool registration"
      contains: "twining_export"
  key_links:
    - from: "src/tools/export-tools.ts"
      to: "src/engine/exporter.ts"
      via: "exporter.exportMarkdown() call"
      pattern: "exporter\\.exportMarkdown"
    - from: "src/engine/exporter.ts"
      to: "src/storage/blackboard-store.ts"
      via: "reads blackboard entries"
      pattern: "blackboardStore\\.read"
    - from: "src/engine/exporter.ts"
      to: "src/storage/decision-store.ts"
      via: "reads decision index and full decisions"
      pattern: "decisionStore\\.(getIndex|get)"
    - from: "src/engine/exporter.ts"
      to: "src/storage/graph-store.ts"
      via: "reads entities and relations"
      pattern: "graphStore\\.get(Entities|Relations)"
    - from: "src/server.ts"
      to: "src/tools/export-tools.ts"
      via: "registerExportTools import and call"
      pattern: "registerExportTools"
---

<objective>
Add `twining_export` tool that dumps full Twining state (blackboard, decisions, graph) as a single readable markdown document, with optional scope filtering.

Purpose: Agents and humans need a snapshot of all shared knowledge. This enables handoff between context windows, documentation generation, and debugging of Twining state.

Output: New `Exporter` engine class, `twining_export` MCP tool, and tests.
</objective>

<execution_context>
@/Users/dave/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dave/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-search-export/06-01-SUMMARY.md
@src/storage/blackboard-store.ts
@src/storage/decision-store.ts
@src/storage/graph-store.ts
@src/utils/types.ts
@src/utils/errors.ts
@src/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Exporter engine class</name>
  <files>src/engine/exporter.ts</files>
  <action>
Create a new `src/engine/exporter.ts` module with an `Exporter` class.

1. Constructor accepts:
   - `blackboardStore: BlackboardStore`
   - `decisionStore: DecisionStore`
   - `graphStore: GraphStore`

2. Main method `async exportMarkdown(scope?: string): Promise<{ markdown: string; stats: ExportStats }>`:
   - If `scope` is provided, filter all data to that scope (prefix match, same pattern as existing code)
   - If no scope, include everything

3. Markdown generation — build a single string with these sections:

   ```markdown
   # Twining State Export

   *Exported: {ISO timestamp}*
   {*Scope: {scope}* — only if scope provided}

   ## Summary

   - Blackboard entries: {N}
   - Decisions: {N} ({active} active, {provisional} provisional, {superseded} superseded, {overridden} overridden)
   - Graph entities: {N}
   - Graph relations: {N}

   ## Decisions

   ### {decision.summary}

   | Field | Value |
   |-------|-------|
   | ID | {id} |
   | Domain | {domain} |
   | Scope | {scope} |
   | Status | {status} |
   | Confidence | {confidence} |
   | Timestamp | {timestamp} |
   | Commits | {commit_hashes.join(", ") or "none"} |

   **Context:** {context}

   **Rationale:** {rationale}

   {If alternatives.length > 0:}
   **Alternatives considered:**
   - {option}: {reason_rejected}

   ---

   ## Blackboard

   | Timestamp | Type | Summary | Scope |
   |-----------|------|---------|-------|
   | {timestamp} | {entry_type} | {summary} | {scope} |

   ## Knowledge Graph

   ### Entities

   | Name | Type | Properties |
   |------|------|------------|
   | {name} | {type} | {JSON.stringify(properties)} |

   ### Relations

   | Source | Relation | Target |
   |--------|----------|--------|
   | {source entity name} | {type} | {target entity name} |
   ```

4. For scope filtering:
   - Blackboard: filter where `entry.scope` prefix-matches the scope (bidirectional, same as existing pattern)
   - Decisions: filter via index where `entry.scope` prefix-matches the scope OR `affected_files` prefix-match
   - Graph: filter entities where `entity.name` or any property value contains the scope substring; include relations where either source or target entity is included

5. `ExportStats` type:
   ```typescript
   interface ExportStats {
     blackboard_entries: number;
     decisions: number;
     graph_entities: number;
     graph_relations: number;
     scope: string;
   }
   ```

6. For the relations table, resolve entity IDs to names. Build a `Map<string, string>` of entity ID to name from the entities list. If an entity ID is not found (orphan relation), use the raw ID.

7. Sort decisions by timestamp descending. Sort blackboard by timestamp descending. Sort entities alphabetically by name.
  </action>
  <verify>Run `npx tsc --noEmit` — compiles clean.</verify>
  <done>Exporter class reads all three stores, generates well-formatted markdown, supports scope filtering, returns stats alongside markdown content.</done>
</task>

<task type="auto">
  <name>Task 2: Register twining_export tool and wire into server</name>
  <files>src/tools/export-tools.ts, src/server.ts</files>
  <action>
1. Create `src/tools/export-tools.ts`:
   - Follow the exact pattern of `context-tools.ts` or `lifecycle-tools.ts`
   - Export function `registerExportTools(server: McpServer, exporter: Exporter): void`
   - Register `twining_export` tool:
     - Description: "Export full Twining state as a single markdown document. Includes blackboard entries, decisions with full rationale, and knowledge graph entities/relations. Use for handoff between context windows, documentation, or debugging."
     - Input schema:
       - `scope: z.string().optional().describe("Optional scope filter to export only a subset of state (e.g., 'src/auth/'). If omitted, exports everything.")`
     - Handler: call `exporter.exportMarkdown(args.scope)`, return result via `toolResult()`. Follow try/catch with TwiningError pattern.

2. In `src/server.ts`:
   - Add import: `import { Exporter } from "./engine/exporter.js";`
   - Add import: `import { registerExportTools } from "./tools/export-tools.js";`
   - Create exporter instance after graphStore/archiver creation:
     ```typescript
     const exporter = new Exporter(blackboardStore, decisionStore, graphStore);
     ```
   - Register tools after existing registrations:
     ```typescript
     registerExportTools(server, exporter);
     ```
  </action>
  <verify>Run `npx tsc --noEmit` — compiles clean. Grep for "twining_export" in src/tools/ to confirm registration.</verify>
  <done>twining_export tool is registered with optional scope parameter. Server creates Exporter and passes to registerExportTools. TypeScript compiles clean.</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for Exporter</name>
  <files>src/engine/exporter.test.ts</files>
  <action>
Create `src/engine/exporter.test.ts` with vitest tests. Use temp directories and real store instances (not mocks) — same pattern as other engine tests in the project.

Test cases:
1. **Export empty state** — No data in stores. Export should produce valid markdown with all section headers and zeroed stats.
2. **Export with decisions** — Create 2 decisions via DecisionStore. Export. Verify markdown contains both decision summaries, rationale, and the decisions table. Verify stats.decisions === 2.
3. **Export with blackboard entries** — Append 3 entries via BlackboardStore. Export. Verify markdown contains a blackboard table with 3 rows. Verify stats.blackboard_entries === 3.
4. **Export with graph** — Add 2 entities and 1 relation via GraphStore. Export. Verify entities table has 2 rows, relations table has 1 row with resolved entity names.
5. **Scope filtering** — Create decisions in scope "src/auth/" and "src/api/". Export with scope="src/auth/". Verify only auth decisions appear. Verify api decisions are excluded.
6. **Full export with all data** — Populate all three stores. Export without scope. Verify all data appears and stats match.

Setup helper: create a `setupStores(tmpDir: string)` that initializes BlackboardStore, DecisionStore, GraphStore with proper directory structure (use `ensureInitialized` from storage/init.ts).
  </action>
  <verify>Run `npx vitest run src/engine/exporter.test.ts` — all tests pass.</verify>
  <done>6 test cases covering empty state, each data type individually, scope filtering, and full combined export. All pass.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles clean
2. `npx vitest run` — all tests pass (including new exporter tests)
3. `grep -r "twining_export" src/` confirms tool registration
4. Export with no scope includes all blackboard entries, decisions, and graph data
5. Export with scope filters to only the relevant subset
</verification>

<success_criteria>
- twining_export tool is registered and callable
- Exporting without scope produces complete markdown with all Twining state
- Exporting with scope filters blackboard, decisions, and graph to matching items
- Markdown is well-formatted with headers, tables, and decision details
- Stats object accurately counts exported items
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-search-export/06-02-SUMMARY.md`
</output>
