---
phase: 05-gsd-bridge-serena-docs
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/engine/decisions.ts
  - test/decision-engine.test.ts
  - CLAUDE.md
autonomous: true
requirements:
  - GSDB-03
  - SRNA-01

must_haves:
  truths:
    - "After twining_decide is called, the decision summary is appended to .planning/STATE.md Accumulated Context > Decisions section"
    - "If .planning/STATE.md does not exist, decide() works exactly as before (no error, no file creation)"
    - "CLAUDE.md contains the Serena-mediated workflow for knowledge graph enrichment after twining_decide"
  artifacts:
    - path: "src/engine/decisions.ts"
      provides: "Updated decide() that syncs decisions to STATE.md"
    - path: "test/decision-engine.test.ts"
      provides: "Tests for STATE.md sync behavior"
    - path: "CLAUDE.md"
      provides: "Serena enrichment workflow documentation"
  key_links:
    - from: "src/engine/decisions.ts"
      to: ".planning/STATE.md"
      via: "fs.readFileSync + appendFileSync"
      pattern: "syncToPlanning"
    - from: "CLAUDE.md"
      to: "Serena knowledge graph workflow"
      via: "documentation section"
---

<objective>
Wire decision creation to sync summaries to .planning/STATE.md and document the Serena knowledge graph enrichment workflow in CLAUDE.md.

Purpose: Ensures planning state stays in sync with Twining decisions (so GSD agents see recent decisions without checking Twining separately), and provides agents with clear instructions for enriching the knowledge graph using Serena's code intelligence.

Output: Updated DecisionEngine with STATE.md sync, tests, enriched CLAUDE.md.
</objective>

<execution_context>
@/Users/dave/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dave/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/engine/decisions.ts
@test/decision-engine.test.ts
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add STATE.md sync to DecisionEngine.decide()</name>
  <files>
    src/engine/decisions.ts
    test/decision-engine.test.ts
  </files>
  <action>
Update `src/engine/decisions.ts`:

1. Add a `projectRoot` parameter to the DecisionEngine constructor (optional, after indexManager): `projectRoot?: string | null`. Store as `this.projectRoot = projectRoot ?? null`.

2. Add a private method `private syncToPlanning(summary: string): void`:
   - If `this.projectRoot` is null, return immediately.
   - Construct path: `path.join(this.projectRoot, '.planning', 'STATE.md')`.
   - If the file doesn't exist, return (don't create it).
   - Read the file content.
   - Find the `### Decisions` section under `## Accumulated Context`.
   - Append `- ${summary}` on a new line after the last line in the Decisions section (before the next `###` header or `## ` header).
   - Write the file back.
   - Wrap everything in try/catch — never let planning sync failure prevent the decide operation. Log to stderr on error.

3. Call `this.syncToPlanning(decision.summary)` at the end of `decide()`, after the blackboard cross-post and embedding generation, before returning the result.

Note: This intentionally uses direct `fs` calls (not file-store.ts) because STATE.md is NOT a Twining data file — it's an external GSD planning file. The file-store abstraction is for `.twining/` data. Adding a direct `import fs` is acceptable here.

Update `test/decision-engine.test.ts`:
- Add a test that creates a temp directory with `.planning/STATE.md` containing the standard format (with `### Decisions` section), creates a DecisionEngine with projectRoot set, calls `decide()`, and verifies the decision summary appears in STATE.md.
- Add a test that decide() works normally when projectRoot is null (no sync).
- Add a test that decide() works normally when `.planning/STATE.md` doesn't exist at projectRoot (no error).
- Add a test that malformed STATE.md (missing Decisions section) doesn't crash decide().

Update `src/server.ts`:
- Pass `projectRoot` to `new DecisionEngine(decisionStore, blackboardEngine, embedder, indexManager, projectRoot)` as the last argument.
  </action>
  <verify>
Run `npx vitest run test/decision-engine.test.ts` — all tests pass including new STATE.md sync tests.
Run `npx tsc --noEmit` — no type errors.
Run `npx vitest run` — full test suite passes.
  </verify>
  <done>
After twining_decide, the decision summary is appended to .planning/STATE.md Accumulated Context > Decisions section. No errors when .planning/ doesn't exist. No errors on malformed STATE.md. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document Serena enrichment workflow in CLAUDE.md</name>
  <files>
    CLAUDE.md
  </files>
  <action>
Append a new section to `CLAUDE.md` documenting the Serena-mediated knowledge graph enrichment workflow.

Add the following section after the existing "Key Constraint" section:

```markdown
## Serena Knowledge Graph Enrichment Workflow

When Serena MCP tools are available alongside Twining, agents should enrich Twining's knowledge graph after making decisions that affect code structure. This is an agent-mediated workflow — the agent orchestrates both Serena and Twining tools.

### After `twining_decide` (when decision affects code symbols):

1. **Identify affected symbols** from the decision's `affected_files` and `affected_symbols`
2. **Use Serena** to analyze the symbols:
   - `find_symbol` to get full symbol details (class, function, method)
   - `find_referencing_symbols` to discover usage patterns
   - `get_symbols_overview` for file-level structure
3. **Use Twining** to record the code structure:
   - `twining_add_entity` for each significant symbol (classes, key functions, modules)
   - `twining_add_relation` for dependencies between symbols (calls, imports, implements)
   - Link entities to decisions with `decided_by` relations
4. **Example flow:**
   ```
   # Agent makes a decision
   twining_decide(domain="architecture", scope="src/auth/", summary="Use JWT middleware pattern", ...)

   # Agent uses Serena to understand the code
   serena.find_symbol("JwtMiddleware")  # Get symbol details
   serena.find_referencing_symbols("JwtMiddleware")  # Find usage

   # Agent enriches Twining's knowledge graph
   twining_add_entity(name="JwtMiddleware", type="class", properties={file: "src/auth/jwt.ts"})
   twining_add_entity(name="AuthRouter", type="module", properties={file: "src/auth/router.ts"})
   twining_add_relation(source="AuthRouter", target="JwtMiddleware", type="imports")
   ```

### When NOT to enrich:
- Trivial decisions (naming, formatting, config values)
- Decisions that don't affect code structure
- When Serena tools are not available in the current session
```

This is documentation only — no code changes needed. The workflow is agent-mediated: agents read CLAUDE.md and follow the instructions using both tool sets.
  </action>
  <verify>
Read CLAUDE.md and confirm the Serena enrichment workflow section is present with clear instructions, example flow, and "when not to enrich" guidance.
  </verify>
  <done>
CLAUDE.md contains clear, actionable instructions for the Serena-mediated knowledge graph enrichment workflow including when to use it, step-by-step flow, example tool calls, and when to skip it.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` — full test suite passes with no regressions
2. `npx tsc --noEmit` — no type errors
3. Manual verification: Call `twining_decide` in a project with `.planning/STATE.md` — decision summary appears in the Decisions section
4. Manual verification: Call `twining_decide` in a project without `.planning/` — works normally, no errors
5. CLAUDE.md contains Serena workflow documentation
</verification>

<success_criteria>
- decide() syncs decision summaries to .planning/STATE.md (GSDB-03)
- STATE.md sync is resilient — never crashes decide() even on missing/malformed files
- CLAUDE.md documents the Serena enrichment workflow clearly (SRNA-01)
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/05-gsd-bridge-serena-docs/05-02-SUMMARY.md`
</output>
