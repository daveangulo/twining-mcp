---
phase: 04-git-commit-linking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/types.ts
  - src/storage/decision-store.ts
  - src/engine/decisions.ts
  - src/tools/decision-tools.ts
  - test/decision-store.test.ts
  - test/decision-engine.test.ts
autonomous: true
requirements:
  - GITL-01
  - GITL-02

must_haves:
  truths:
    - "A decision created with commit_hash stores the hash and returns it"
    - "An existing decision can have a commit hash linked to it retroactively"
    - "A decision can have multiple commit hashes linked over time"
  artifacts:
    - path: "src/utils/types.ts"
      provides: "Decision interface with commit_hashes field"
      contains: "commit_hashes"
    - path: "src/storage/decision-store.ts"
      provides: "linkCommit method for retroactive linking"
      contains: "linkCommit"
    - path: "src/engine/decisions.ts"
      provides: "linkCommit engine method and commit_hash support in decide"
      contains: "linkCommit"
    - path: "src/tools/decision-tools.ts"
      provides: "twining_link_commit tool and commit_hash param on twining_decide"
      contains: "twining_link_commit"
  key_links:
    - from: "src/tools/decision-tools.ts"
      to: "src/engine/decisions.ts"
      via: "engine.linkCommit()"
      pattern: "engine\\.linkCommit"
    - from: "src/engine/decisions.ts"
      to: "src/storage/decision-store.ts"
      via: "decisionStore.linkCommit()"
      pattern: "decisionStore\\.linkCommit"
---

<objective>
Extend the Decision data model with commit hash tracking and add the ability to link commits both at decision creation time and retroactively.

Purpose: This is the foundation for bidirectional decision-to-commit traceability. Without the data model extension, no query tools can work.
Output: Updated Decision type with `commit_hashes: string[]`, updated `twining_decide` with optional `commit_hash` parameter, new `twining_link_commit` tool.
</objective>

<execution_context>
@/Users/dave/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dave/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/utils/types.ts
@src/storage/decision-store.ts
@src/engine/decisions.ts
@src/tools/decision-tools.ts
@test/decision-store.test.ts
@test/decision-engine.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Decision data model and storage layer with commit hash support</name>
  <files>
    src/utils/types.ts
    src/storage/decision-store.ts
    test/decision-store.test.ts
  </files>
  <action>
    1. In `src/utils/types.ts`, add `commit_hashes: string[]` field to the `Decision` interface (after `affected_symbols`, before `overridden_by`). This is an array because a decision may be linked to multiple commits over time.

    2. In `src/utils/types.ts`, add `commit_hashes: string[]` field to the `DecisionIndexEntry` interface as well — needed for fast commit-based lookups without loading full decision files.

    3. In `src/storage/decision-store.ts`:
       - Update `create()` method: the input type `Omit<Decision, "id" | "timestamp" | "status">` already includes commit_hashes from the Decision interface. Ensure the spread into the new decision preserves commit_hashes. Default to `[]` if not provided by using `input.commit_hashes ?? []` before spreading, or by setting it after spread.
       - Update the `toIndexEntry()` method to include `commit_hashes` in the extracted index entry.
       - Add a new `linkCommit(id: string, commitHash: string): Promise<void>` method that:
         a. Reads the decision JSON file
         b. Appends commitHash to the decision's `commit_hashes` array (avoid duplicates)
         c. Writes the updated decision file
         d. Locks and updates the index.json to reflect the new commit_hashes array
       - Add a new `getByCommitHash(commitHash: string): Promise<Decision[]>` method that:
         a. Reads the index
         b. Filters entries where `commit_hashes` includes the given hash
         c. Loads and returns full Decision objects for matches
         d. Sorts by timestamp descending

    4. In `test/decision-store.test.ts`, add tests:
       - Test that `create()` with `commit_hashes: ["abc123"]` persists the hash in both the file and the index
       - Test that `create()` without commit_hashes defaults to empty array
       - Test `linkCommit()` adds a hash to an existing decision
       - Test `linkCommit()` does not add duplicate hashes
       - Test `linkCommit()` on nonexistent decision throws/returns error
       - Test `getByCommitHash()` returns matching decisions
       - Test `getByCommitHash()` returns empty array for unknown hash
  </action>
  <verify>Run `npx vitest run test/decision-store.test.ts` — all tests pass including new ones.</verify>
  <done>Decision type has commit_hashes field. DecisionStore has linkCommit and getByCommitHash methods. Index entries include commit_hashes. All store-level tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add commit hash support to engine and tools layers</name>
  <files>
    src/engine/decisions.ts
    src/tools/decision-tools.ts
    test/decision-engine.test.ts
  </files>
  <action>
    1. In `src/engine/decisions.ts`:
       - Update the `decide()` method's input type to accept an optional `commit_hash?: string` parameter. When provided, pass `commit_hashes: [commit_hash]` to the store's `create()`. When not provided, pass `commit_hashes: []`.
       - Add a `linkCommit(decisionId: string, commitHash: string, agentId?: string): Promise<{ linked: boolean; decision_summary: string }>` method that:
         a. Verifies the decision exists (throw TwiningError NOT_FOUND if not)
         b. Calls `this.decisionStore.linkCommit(decisionId, commitHash)`
         c. Posts a blackboard entry of type "status" with summary like `Commit ${commitHash.slice(0,7)} linked to decision: ${decision.summary}` (truncate to 200 chars)
         d. Returns `{ linked: true, decision_summary: decision.summary }`
       - Add a `getByCommitHash(commitHash: string): Promise<{ decisions: Array<{ id: string; summary: string; domain: string; scope: string; confidence: string; timestamp: string; commit_hashes: string[] }> }>` method that:
         a. Calls `this.decisionStore.getByCommitHash(commitHash)`
         b. Maps to the output shape (id, summary, domain, scope, confidence, timestamp, commit_hashes)

    2. In `src/tools/decision-tools.ts`:
       - Add `commit_hash` optional parameter to `twining_decide` inputSchema: `commit_hash: z.string().optional().describe("Git commit hash to associate with this decision")`
       - Pass `commit_hash` through to `engine.decide(args)` (it's already spread from args).
       - Register new `twining_link_commit` tool with:
         - description: "Link a git commit hash to an existing decision. Enables bidirectional traceability between decisions and commits."
         - inputSchema: `decision_id: z.string()`, `commit_hash: z.string()`, `agent_id: z.string().optional()`
         - handler: calls `engine.linkCommit(args.decision_id, args.commit_hash, args.agent_id)`
         - Error handling: same pattern as other tools (TwiningError check, generic Error fallback)

    3. In `test/decision-engine.test.ts`, add tests:
       - Test `decide()` with `commit_hash: "abc123"` — verify the created decision has commit_hashes containing "abc123"
       - Test `decide()` without commit_hash — verify commit_hashes is empty array
       - Test `linkCommit()` on existing decision — verify linked is true and decision_summary returned
       - Test `linkCommit()` on nonexistent decision — verify TwiningError thrown
       - Test `linkCommit()` posts a status entry to blackboard
       - Test `getByCommitHash()` returns matching decisions
  </action>
  <verify>Run `npx vitest run test/decision-engine.test.ts` — all tests pass. Run `npx vitest run` — full suite passes (no regressions).</verify>
  <done>DecisionEngine supports commit_hash in decide(), has linkCommit() and getByCommitHash() methods. twining_decide accepts commit_hash parameter. twining_link_commit tool is registered. All tests pass including full suite regression check.</done>
</task>

</tasks>

<verification>
1. `npx vitest run test/decision-store.test.ts` — all store-level tests pass
2. `npx vitest run test/decision-engine.test.ts` — all engine-level tests pass
3. `npx vitest run` — full test suite passes with no regressions
4. `npx tsc --noEmit` — TypeScript compiles without errors
</verification>

<success_criteria>
- Decision interface has `commit_hashes: string[]` field
- DecisionIndexEntry has `commit_hashes: string[]` field
- `twining_decide` accepts optional `commit_hash` parameter
- `twining_link_commit` tool exists and links commits to decisions
- Both store and engine layers have `linkCommit` and `getByCommitHash` methods
- All existing tests pass (no regressions from data model change)
- New tests cover creation with hash, retroactive linking, duplicate prevention, and querying
</success_criteria>

<output>
After completion, create `.planning/phases/04-git-commit-linking/04-01-SUMMARY.md`
</output>
