---
phase: 11-types-and-storage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/types.ts
  - src/utils/liveness.ts
  - src/utils/tags.ts
  - src/storage/init.ts
  - src/config.ts
  - test/liveness.test.ts
  - test/tags.test.ts
  - test/init.test.ts
autonomous: true
requirements:
  - REG-01
  - REG-02
  - REG-03
  - REG-04
  - HND-05

must_haves:
  truths:
    - "AgentRecord, HandoffRecord, HandoffResult, HandoffIndexEntry, AgentLiveness, and LivenessThresholds types are defined and exported"
    - "computeLiveness returns 'active' for recent timestamps, 'idle' for medium, 'gone' for old, with configurable thresholds"
    - "normalizeTags lowercases, trims, deduplicates, and filters empty strings"
    - "initTwiningDir creates agents/ and handoffs/ directories with empty registry.json"
    - "TwiningConfig includes agents.liveness threshold configuration"
  artifacts:
    - path: "src/utils/types.ts"
      provides: "AgentRecord, HandoffRecord, HandoffResult, HandoffIndexEntry, AgentLiveness, LivenessThresholds interfaces"
      contains: "AgentRecord"
    - path: "src/utils/liveness.ts"
      provides: "computeLiveness pure function with DEFAULT_LIVENESS_THRESHOLDS"
      exports: ["computeLiveness", "DEFAULT_LIVENESS_THRESHOLDS"]
    - path: "src/utils/tags.ts"
      provides: "normalizeTags utility function"
      exports: ["normalizeTags"]
    - path: "src/storage/init.ts"
      provides: "Extended init creating agents/ and handoffs/ directories"
      contains: "agents"
    - path: "test/liveness.test.ts"
      provides: "Tests for computeLiveness"
    - path: "test/tags.test.ts"
      provides: "Tests for normalizeTags"
  key_links:
    - from: "src/utils/liveness.ts"
      to: "src/utils/types.ts"
      via: "imports AgentLiveness and LivenessThresholds types"
      pattern: "import.*LivenessThresholds.*types"
    - from: "src/storage/init.ts"
      to: ".twining/agents/registry.json"
      via: "creates directory and empty JSON array file"
      pattern: "agents.*registry\\.json"
---

<objective>
Define all agent coordination type interfaces, utility functions (liveness computation, tag normalization), extend init to create new directories, and add agent liveness config to TwiningConfig.

Purpose: Establish the foundational types and utilities that AgentStore (Plan 02) and HandoffStore (Plan 03) depend on. Everything downstream in Phases 11-14 imports these types.

Output: Type definitions in types.ts, two utility modules with tests, extended init.ts, extended config.
</objective>

<execution_context>
@/Users/dave/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dave/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-types-and-storage/11-RESEARCH.md
@src/utils/types.ts
@src/storage/init.ts
@src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add agent coordination types and config extension</name>
  <files>src/utils/types.ts, src/config.ts</files>
  <action>
Add the following interfaces to `src/utils/types.ts` after the existing `DecisionIndexEntry` interface:

1. `AgentLiveness` type: `"active" | "idle" | "gone"`

2. `LivenessThresholds` interface with `idle_after_ms: number` and `gone_after_ms: number`

3. `AgentRecord` interface:
   - `agent_id: string` (agent-provided identifier, e.g., "main", "researcher-1")
   - `capabilities: string[]` (free-form tags, normalized lowercase per REG-03)
   - `role?: string` (optional role description)
   - `description?: string` (optional human-readable description)
   - `registered_at: string` (ISO 8601 -- first seen)
   - `last_active: string` (ISO 8601 -- last tool call)

4. `HandoffResult` interface:
   - `description: string` (what was accomplished)
   - `status: "completed" | "partial" | "blocked" | "failed"`
   - `artifacts?: string[]` (file paths or references produced)
   - `notes?: string` (additional context)

5. `HandoffRecord` interface:
   - `id: string` (ULID)
   - `created_at: string` (ISO 8601)
   - `source_agent: string` (agent ID that created the handoff)
   - `target_agent?: string` (optional intended recipient agent ID)
   - `scope?: string` (optional codebase area, prefix-matchable like decision scopes)
   - `summary: string` (one-line summary)
   - `results: HandoffResult[]` (structured results with status)
   - `context_snapshot: { decision_ids: string[]; warning_ids: string[]; finding_ids: string[]; summaries: string[] }` (referenced IDs and summaries, not full objects)
   - `acknowledged_by?: string` (agent ID that acknowledged receipt)
   - `acknowledged_at?: string` (ISO 8601)

6. `HandoffIndexEntry` interface (lightweight for JSONL index):
   - `id: string`
   - `created_at: string`
   - `source_agent: string`
   - `target_agent?: string`
   - `scope?: string`
   - `summary: string`
   - `result_status: string` (aggregate: "completed" | "partial" | "blocked" | "failed" | "mixed")
   - `acknowledged: boolean`

Then extend `TwiningConfig` in `types.ts` to add an optional `agents` section:
```typescript
agents?: {
  liveness: {
    idle_after_ms: number;
    gone_after_ms: number;
  };
};
```

In `src/config.ts`, add the `agents` section to `DEFAULT_CONFIG`:
```typescript
agents: {
  liveness: {
    idle_after_ms: 300000,    // 5 minutes
    gone_after_ms: 1800000,   // 30 minutes
  },
},
```
  </action>
  <verify>Run `npx tsc --noEmit` to confirm types compile without errors.</verify>
  <done>All 6 type interfaces are exported from types.ts. TwiningConfig includes agents.liveness. DEFAULT_CONFIG includes liveness defaults. TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Create liveness and tag utility functions with tests</name>
  <files>src/utils/liveness.ts, src/utils/tags.ts, test/liveness.test.ts, test/tags.test.ts</files>
  <action>
Create `src/utils/liveness.ts`:
- Import `AgentLiveness` and `LivenessThresholds` from `./types.js`
- Export `DEFAULT_LIVENESS_THRESHOLDS: LivenessThresholds` with `idle_after_ms: 5 * 60 * 1000` (5 min) and `gone_after_ms: 30 * 60 * 1000` (30 min)
- Export `computeLiveness(lastActive: string, now: Date = new Date(), thresholds: LivenessThresholds = DEFAULT_LIVENESS_THRESHOLDS): AgentLiveness`
  - Calculate elapsed ms: `now.getTime() - new Date(lastActive).getTime()`
  - If elapsed < idle_after_ms return "active"
  - If elapsed < gone_after_ms return "idle"
  - Else return "gone"

Create `src/utils/tags.ts`:
- Export `normalizeTags(tags: string[]): string[]`
  - Map each tag to `tag.toLowerCase().trim()`
  - Filter out empty strings
  - Deduplicate using `[...new Set(result)]`

Create `test/liveness.test.ts` with vitest:
- Test "active" when last_active is within 5 minutes of now
- Test "idle" when last_active is 10 minutes ago
- Test "gone" when last_active is 60 minutes ago
- Test custom thresholds override defaults
- Test edge case: exactly at threshold boundary (should be "active" at exactly idle_after_ms - 1, "idle" at idle_after_ms)
- Test future timestamp (last_active ahead of now) returns "active"

Create `test/tags.test.ts` with vitest:
- Test lowercase normalization: `["Testing", "CODE-REVIEW"]` -> `["testing", "code-review"]`
- Test trim: `["  spaces  ", "tabs"]` -> `["spaces", "tabs"]`
- Test deduplication: `["test", "Test", "TEST"]` -> `["test"]`
- Test empty string filtering: `["", "  ", "valid"]` -> `["valid"]`
- Test empty array returns empty array
- Test mixed case with duplicates: `["Testing", "testing", " Testing "]` -> `["testing"]`
  </action>
  <verify>Run `npx vitest run test/liveness.test.ts test/tags.test.ts` -- all tests pass.</verify>
  <done>computeLiveness correctly classifies agent states with configurable thresholds. normalizeTags handles lowercase, trim, dedup, and empty filtering. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 3: Extend init.ts to create agents/ and handoffs/ directories</name>
  <files>src/storage/init.ts, test/init.test.ts</files>
  <action>
Extend `initTwiningDir` in `src/storage/init.ts`:

After the existing `fs.mkdirSync(path.join(twiningDir, "archive"), { recursive: true });` line, add:
```typescript
fs.mkdirSync(path.join(twiningDir, "agents"), { recursive: true });
fs.mkdirSync(path.join(twiningDir, "handoffs"), { recursive: true });
```

After the existing empty data files section (after the graph relations.json write), add:
```typescript
fs.writeFileSync(
  path.join(twiningDir, "agents", "registry.json"),
  JSON.stringify([], null, 2),
);
```
Note: Do NOT create an empty index.jsonl for handoffs -- `appendJSONL` in file-store.ts already creates the file on first write.

Create `test/init.test.ts` with vitest:
- Use `beforeEach` to create a fresh temp directory and `afterEach` to clean it up
- Test that `initTwiningDir` creates `.twining/agents/` directory
- Test that `initTwiningDir` creates `.twining/handoffs/` directory
- Test that `initTwiningDir` creates `.twining/agents/registry.json` with `[]`
- Test that calling `initTwiningDir` twice is idempotent (doesn't error, doesn't overwrite)
- Test that `ensureInitialized` returns the correct path and creates all directories

Important: The existing early-return `if (fs.existsSync(twiningDir)) return;` means the new directories are only created when `.twining/` doesn't exist yet. This is fine -- the stores themselves should handle missing directories gracefully (using `ensureDir` or checking existence).
  </action>
  <verify>Run `npx vitest run test/init.test.ts` -- all tests pass. Also run `npx vitest run` to confirm no existing tests broke.</verify>
  <done>initTwiningDir creates agents/ and handoffs/ directories with empty registry.json. Tests verify directory and file creation. Existing tests still pass. Full test suite green.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (all types compile)
2. `npx vitest run test/liveness.test.ts test/tags.test.ts test/init.test.ts` -- all new tests pass
3. `npx vitest run` -- full test suite passes (no regressions)
4. `.twining/agents/` and `.twining/handoffs/` directories created by init
5. All new types importable from `../utils/types.js`
</verification>

<success_criteria>
- AgentRecord, HandoffRecord, HandoffResult, HandoffIndexEntry, AgentLiveness, LivenessThresholds all exported from types.ts
- computeLiveness correctly returns active/idle/gone based on elapsed time and thresholds
- normalizeTags handles lowercase, trim, dedup, empty filtering
- initTwiningDir creates agents/ and handoffs/ directories with registry.json
- TwiningConfig has agents.liveness section with configurable thresholds
- All tests pass including existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/11-types-and-storage/11-01-SUMMARY.md`
</output>
