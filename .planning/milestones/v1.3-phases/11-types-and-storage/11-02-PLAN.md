---
phase: 11-types-and-storage
plan: 02
type: tdd
wave: 2
depends_on:
  - "11-01"
files_modified:
  - src/storage/agent-store.ts
  - test/agent-store.test.ts
autonomous: true
requirements:
  - REG-01
  - REG-02
  - REG-03
  - REG-04

must_haves:
  truths:
    - "AgentStore.upsert creates a new agent record with agent_id, capabilities, role, description, and timestamps"
    - "AgentStore.upsert merges capabilities (union) and overwrites role/description on re-registration"
    - "AgentStore.touch updates last_active timestamp, creating a minimal record if agent doesn't exist"
    - "AgentStore.getAll returns all agents from registry.json"
    - "AgentStore.get returns a single agent by agent_id or null"
    - "AgentStore.findByCapabilities returns agents with any matching capability tag (OR match)"
    - "Capability tags are normalized (lowercase, trimmed, deduped) on write"
  artifacts:
    - path: "src/storage/agent-store.ts"
      provides: "AgentStore class with upsert, touch, get, getAll, findByCapabilities"
      exports: ["AgentStore"]
    - path: "test/agent-store.test.ts"
      provides: "Comprehensive tests for AgentStore CRUD and querying"
  key_links:
    - from: "src/storage/agent-store.ts"
      to: "src/utils/types.ts"
      via: "imports AgentRecord type"
      pattern: "import.*AgentRecord.*types"
    - from: "src/storage/agent-store.ts"
      to: "src/storage/file-store.ts"
      via: "uses readJSON and writeJSON for locked file I/O"
      pattern: "import.*readJSON.*writeJSON.*file-store"
    - from: "src/storage/agent-store.ts"
      to: "src/utils/tags.ts"
      via: "uses normalizeTags for capability tag normalization"
      pattern: "import.*normalizeTags.*tags"
---

<objective>
Implement AgentStore with full CRUD operations using TDD (RED-GREEN-REFACTOR). AgentStore persists agent records to `.twining/agents/registry.json` as a single JSON array file with upsert semantics.

Purpose: Agent records are the foundation for all coordination features in Phases 12-14. The store must support auto-registration (touch), explicit registration (upsert), and capability-based discovery (findByCapabilities).

Output: Working AgentStore class with comprehensive test coverage.
</objective>

<execution_context>
@/Users/dave/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dave/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-types-and-storage/11-RESEARCH.md
@.planning/phases/11-types-and-storage/11-01-SUMMARY.md
@src/utils/types.ts
@src/storage/file-store.ts
@src/storage/graph-store.ts
@src/utils/tags.ts
</context>

<feature>
  <name>AgentStore</name>
  <files>src/storage/agent-store.ts, test/agent-store.test.ts</files>
  <behavior>
AgentStore manages agent records in `.twining/agents/registry.json` (JSON array).
Follows GraphStore's single-file pattern with upsert semantics by agent_id.

**Constructor:**
- `constructor(twiningDir: string)` -- sets `registryPath` to `path.join(twiningDir, "agents", "registry.json")`

**upsert(input: { agent_id: string; capabilities?: string[]; role?: string; description?: string }): Promise&lt;AgentRecord&gt;**
- If agent_id exists in registry: merge capabilities (union with normalizeTags), overwrite role/description if provided (not undefined), update last_active to now
- If agent_id doesn't exist: create new record with agent_id, normalized capabilities (default []), role, description, registered_at=now, last_active=now
- Uses readJSON/writeJSON from file-store.ts for locked I/O
- Returns the created or updated AgentRecord

**touch(agentId: string): Promise&lt;AgentRecord&gt;**
- If agent exists: update last_active to now, return updated record
- If agent doesn't exist: create minimal record with just agent_id, empty capabilities, registered_at=now, last_active=now, return it
- This is the "auto-register on first tool call" path (REG-01)

**get(agentId: string): Promise&lt;AgentRecord | null&gt;**
- Returns single agent by agent_id, or null if not found

**getAll(): Promise&lt;AgentRecord[]&gt;**
- Returns all agents from registry.json

**findByCapabilities(tags: string[]): Promise&lt;AgentRecord[]&gt;**
- Normalizes input tags
- Returns agents where any capability matches any input tag (OR match)
- Match is exact string equality after normalization

Test cases:
- upsert creates new agent -> verify all fields including timestamps
- upsert same agent_id merges capabilities (union, no dupes)
- upsert same agent_id overwrites role when provided
- upsert same agent_id does NOT overwrite role when role is undefined
- upsert normalizes capability tags (lowercase, trim, dedup)
- touch creates minimal record for unknown agent
- touch updates last_active for known agent, doesn't change capabilities/role
- get returns null for unknown agent_id
- get returns agent for known agent_id
- getAll returns empty array on fresh store
- getAll returns all agents after multiple upserts
- findByCapabilities returns matching agents (OR match)
- findByCapabilities returns empty array when no match
- findByCapabilities normalizes input tags before matching
- findByCapabilities with empty tags returns empty array
- concurrent upserts don't corrupt data (two sequential upserts)
  </behavior>
  <implementation>
Follow GraphStore.addEntity pattern:
1. Read JSON array from file under lock (readJSON)
2. Find existing by agent_id
3. Merge or create
4. Write back full array under lock (writeJSON)

Use `normalizeTags` from `src/utils/tags.ts` for all capability writes.
Use `readJSON<AgentRecord[]>` and `writeJSON` from `src/storage/file-store.ts`.

Handle missing registry.json gracefully: if readJSON throws (file doesn't exist), treat as empty array. Use ensureDir to create agents/ if needed before first write.

Test setup follows existing pattern (decision-store.test.ts):
- beforeEach: create tmpDir, create agents/ subdir, write empty registry.json
- afterEach: rm -rf tmpDir
  </implementation>
</feature>

<verification>
1. `npx vitest run test/agent-store.test.ts` -- all tests pass
2. `npx vitest run` -- full test suite passes (no regressions)
3. `npx tsc --noEmit` -- compiles cleanly
</verification>

<success_criteria>
- AgentStore.upsert creates and updates agent records with proper merging
- AgentStore.touch provides auto-register path (REG-01)
- Capability tags always normalized on write (REG-03)
- findByCapabilities supports OR-match discovery
- All data persists to registry.json as JSON array
- Comprehensive test suite with 15+ test cases
</success_criteria>

<output>
After completion, create `.planning/phases/11-types-and-storage/11-02-SUMMARY.md`
</output>
