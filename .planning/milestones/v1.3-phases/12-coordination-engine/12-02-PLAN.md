---
phase: 12-coordination-engine
plan: 02
type: tdd
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/engine/coordination.ts
  - test/coordination-engine.test.ts
  - src/config.ts
autonomous: true
requirements: [DEL-02, DEL-03, DEL-06, DEL-07]

must_haves:
  truths:
    - "A delegation need posted via postDelegation() creates a blackboard 'need' entry with JSON-encoded DelegationMetadata in detail field"
    - "postDelegation() returns suggested matching agents ranked by score alongside the entry ID"
    - "Urgency levels (high/normal/low) map to default timeouts (5min/30min/4hr) that set expires_at"
    - "timeout_ms override replaces the urgency-based default"
    - "parseDelegationMetadata() returns null for non-delegation entries and malformed JSON"
    - "isDelegationExpired() correctly identifies expired vs active delegation needs"
  artifacts:
    - path: "src/engine/coordination.ts"
      provides: "postDelegation method, parseDelegationMetadata, isDelegationExpired, DELEGATION_TIMEOUTS"
      exports: ["parseDelegationMetadata", "isDelegationExpired", "DELEGATION_TIMEOUTS"]
    - path: "src/config.ts"
      provides: "delegations config section with default timeouts"
      contains: "delegations"
    - path: "test/coordination-engine.test.ts"
      provides: "Tests for delegation posting, expiry, and metadata parsing"
      min_lines: 150
  key_links:
    - from: "src/engine/coordination.ts"
      to: "src/engine/blackboard.ts"
      via: "BlackboardEngine.post() in postDelegation()"
      pattern: "blackboardEngine\\.post"
    - from: "src/engine/coordination.ts"
      to: "src/engine/coordination.ts"
      via: "discover() called by postDelegation() for agent suggestions"
      pattern: "this\\.discover"
---

<objective>
Implement delegation posting with urgency-based expiry and agent matching suggestions.

Purpose: Enable agents to post delegation needs to the blackboard with structured metadata, automatic agent matching, and configurable expiry timeouts. This is the core delegation workflow -- agents say "I need someone who can do X" and the system suggests who.

Output: postDelegation() method, delegation helpers (parseDelegationMetadata, isDelegationExpired, DELEGATION_TIMEOUTS), config extension
</objective>

<execution_context>
@/Users/dave/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dave/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-coordination-engine/12-RESEARCH.md
@.planning/phases/12-coordination-engine/12-01-SUMMARY.md
@src/engine/coordination.ts
@src/engine/blackboard.ts
@src/config.ts
@src/utils/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED - Write failing tests for postDelegation, helpers, and config</name>
  <files>test/coordination-engine.test.ts, src/config.ts</files>
  <action>
**Step 1: Extend TwiningConfig** in `src/utils/types.ts` to add optional `delegations` section:
```typescript
// Add to TwiningConfig interface:
delegations?: {
  timeouts: {
    high_ms: number;
    normal_ms: number;
    low_ms: number;
  };
};
```

**Step 2: Add default delegation config** to `src/config.ts` DEFAULT_CONFIG:
```typescript
delegations: {
  timeouts: {
    high_ms: 300000,       // 5 minutes
    normal_ms: 1800000,    // 30 minutes
    low_ms: 14400000,      // 4 hours
  },
},
```

**Step 3: Add failing tests** to `test/coordination-engine.test.ts` in new describe blocks:

Tests for `parseDelegationMetadata(entry)`:
1. Returns DelegationMetadata from valid delegation entry
2. Returns null for entry with non-delegation detail
3. Returns null for entry with invalid JSON in detail
4. Returns null for entry with empty detail string

Tests for `isDelegationExpired(metadata, now)`:
1. Returns false when now is before expires_at
2. Returns true when now is after expires_at
3. Returns true when now equals expires_at (boundary)

Tests for `DELEGATION_TIMEOUTS`:
1. Has entries for "high", "normal", "low"
2. high < normal < low (ordering check)

Tests for `postDelegation()`:
1. Posts a "need" entry to blackboard with delegation metadata in detail
2. Returns entry_id, timestamp, expires_at, and suggested_agents
3. Default urgency is "normal" with 30-minute timeout
4. High urgency uses 5-minute timeout
5. Low urgency uses 4-hour timeout
6. Custom timeout_ms overrides urgency-based default
7. Tags include "delegation" and urgency level
8. Scope defaults to "project" when not specified
9. required_capabilities are normalized before storing in metadata
10. suggested_agents comes from discover() with include_gone=false
11. Register 2 agents with different capabilities, post delegation -- verify suggested_agents ranked correctly

Run `npx vitest run test/coordination-engine.test.ts` -- new tests MUST fail (RED).
  </action>
  <verify>Run `npx vitest run test/coordination-engine.test.ts` -- previously-passing scoreAgent/discover tests still pass; new delegation tests fail. `npx tsc --noEmit` passes.</verify>
  <done>15+ new failing tests for delegation posting, expiry, and metadata parsing. Config extended with delegation timeouts.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN - Implement postDelegation, helpers, and DELEGATION_TIMEOUTS</name>
  <files>src/engine/coordination.ts</files>
  <action>
Implement in `src/engine/coordination.ts`:

**DELEGATION_TIMEOUTS** (exported constant):
```typescript
export const DELEGATION_TIMEOUTS: Record<DelegationUrgency, number> = {
  high: 300000,       // 5 minutes
  normal: 1800000,    // 30 minutes
  low: 14400000,      // 4 hours
};
```
Note: Read from config if available (`this.config.delegations?.timeouts`), falling back to these constants.

**parseDelegationMetadata** (exported function):
- Takes a BlackboardEntry
- Try JSON.parse(entry.detail)
- If parsed and parsed.type === "delegation", return as DelegationMetadata
- On any error or type mismatch, return null

**isDelegationExpired** (exported function):
- Takes DelegationMetadata and optional now Date (default new Date())
- Returns `now.getTime() >= new Date(metadata.expires_at).getTime()` (note: >= for boundary case)

**postDelegation method** on CoordinationEngine:
1. Default urgency to "normal"
2. Compute timeout: `input.timeout_ms ?? configTimeout ?? DELEGATION_TIMEOUTS[urgency]`
   - Where configTimeout reads from `this.config.delegations?.timeouts` using the urgency key (e.g., `high_ms`)
3. Compute expires_at: `new Date(now.getTime() + timeoutMs).toISOString()`
4. Build DelegationMetadata object with type: "delegation", normalized required_capabilities, urgency, expires_at, timeout_ms
5. Post to blackboard via `this.blackboardEngine.post()`:
   - entry_type: "need"
   - summary: input.summary
   - detail: JSON.stringify(metadata)
   - tags: [...(input.tags ?? []), "delegation", urgency]
   - scope: input.scope ?? "project"
   - agent_id: input.agent_id ?? "main"
6. Call `this.discover({ required_capabilities: input.required_capabilities, include_gone: false })` for suggestions
7. Return DelegationResult with entry_id, timestamp, expires_at, suggested_agents
  </action>
  <verify>Run `npx vitest run test/coordination-engine.test.ts` -- ALL tests pass (both old and new). Run `npx tsc --noEmit` -- no type errors.</verify>
  <done>All delegation tests pass. postDelegation creates a blackboard need entry with delegation metadata and returns suggested agents.</done>
</task>

</tasks>

<verification>
```bash
npx vitest run test/coordination-engine.test.ts
npx tsc --noEmit
```
All tests pass including scoreAgent, discover, postDelegation, helpers. Config compiles with new delegations section.
</verification>

<success_criteria>
- postDelegation() posts a "need" entry with JSON-encoded DelegationMetadata in detail field
- Urgency levels correctly map to timeout durations
- Custom timeout_ms overrides urgency-based defaults
- suggested_agents populated via discover() call
- parseDelegationMetadata safely handles malformed input
- isDelegationExpired correctly checks boundary conditions
- Prior Plan 01 tests still pass (no regression)
</success_criteria>

<output>
After completion, create `.planning/phases/12-coordination-engine/12-02-SUMMARY.md`
</output>
