---
phase: 07-http-server-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [src/index.ts]
autonomous: true
gap_closure: true
requirements: [INFRA-07]

must_haves:
  truths:
    - "Dashboard HTTP server shuts down gracefully when MCP process receives SIGTERM or SIGINT"
    - "setupDashboardShutdown is imported and called in src/index.ts"
    - "MCP stdio transport is never blocked by dashboard shutdown wiring"
  artifacts:
    - path: "src/index.ts"
      provides: "Graceful shutdown wiring for dashboard HTTP server"
      contains: "setupDashboardShutdown"
  key_links:
    - from: "src/index.ts"
      to: "src/dashboard/http-server.ts"
      via: "imports setupDashboardShutdown and calls it with server from startDashboard result"
      pattern: "setupDashboardShutdown\\(result\\.server\\)"
---

<objective>
Wire setupDashboardShutdown into MCP lifecycle so the dashboard HTTP server shuts down gracefully on process exit.

Purpose: Close the single remaining gap from Phase 7 verification — setupDashboardShutdown exists but is never called.
Output: src/index.ts imports and invokes setupDashboardShutdown after startDashboard succeeds.
</objective>

<execution_context>
@/Users/dave/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dave/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-http-server-foundation/07-02-SUMMARY.md
@.planning/phases/07-http-server-foundation/07-VERIFICATION.md
@src/index.ts
@src/dashboard/http-server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire setupDashboardShutdown into src/index.ts</name>
  <files>src/index.ts</files>
  <action>
Make two changes to src/index.ts:

1. Add `setupDashboardShutdown` to the existing import from `./dashboard/http-server.js`:
   Change: `import { startDashboard } from "./dashboard/http-server.js";`
   To: `import { startDashboard, setupDashboardShutdown } from "./dashboard/http-server.js";`

2. Replace the fire-and-forget startDashboard call (lines 22-25):
   Change:
   ```typescript
   startDashboard(projectRoot).catch((err) => {
     console.error("[twining] Dashboard failed to start (non-fatal):", (err as Error).message);
   });
   ```
   To:
   ```typescript
   startDashboard(projectRoot).then((result) => {
     if (result) {
       setupDashboardShutdown(result.server);
     }
   }).catch((err) => {
     console.error("[twining] Dashboard failed to start (non-fatal):", (err as Error).message);
   });
   ```

This preserves the fire-and-forget pattern (never awaited, never blocks MCP stdio) while wiring in the SIGTERM/SIGINT handlers when the dashboard starts successfully. When `startDashboard` returns `null` (dashboard disabled), no shutdown handler is registered.

Do NOT change any other code in index.ts. Do NOT modify http-server.ts.
  </action>
  <verify>
1. `npx tsc --noEmit` passes with no errors
2. `grep "setupDashboardShutdown" src/index.ts` shows both the import and the call
3. `npm test` — all existing tests pass (288+)
4. Visually confirm src/index.ts is still compact and the fire-and-forget pattern is preserved (no `await` on the startDashboard call)
  </verify>
  <done>
setupDashboardShutdown is imported in src/index.ts and called with the HTTP server instance after startDashboard resolves successfully. Dashboard disabled case (null result) is handled. MCP stdio is never blocked. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `grep -n "setupDashboardShutdown" src/index.ts` shows import on line ~8 and call inside .then() block
2. `npx tsc --noEmit` passes
3. `npm test` passes with no regressions
4. `grep "setupDashboardShutdown" src/dashboard/http-server.ts` still shows the export (unchanged)
5. The pattern `startDashboard(...).then(...).catch(...)` is present — fire-and-forget preserved
</verification>

<success_criteria>
- INFRA-07 gap is closed: setupDashboardShutdown is imported and called in src/index.ts
- No test regressions
- TypeScript compiles cleanly
- Fire-and-forget pattern preserved (dashboard startup never blocks MCP)
</success_criteria>

<output>
After completion, create `.planning/phases/07-http-server-foundation/07-03-SUMMARY.md`
</output>
