---
phase: 07-http-server-foundation
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/dashboard/public/index.html
  - src/dashboard/public/style.css
  - src/dashboard/public/app.js
  - src/index.ts
  - package.json
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-04
  - INFRA-07

must_haves:
  truths:
    - "Dashboard starts automatically when twining-mcp launches via MCP stdio"
    - "MCP stdio tools work identically whether dashboard is enabled or not"
    - "Dashboard serves a static page that loads without errors in the browser"
    - "Browser auto-opens on dashboard start (unless disabled via env var)"
    - "Dashboard shuts down when MCP process exits"
  artifacts:
    - path: "src/dashboard/public/index.html"
      provides: "Dashboard shell HTML page"
      contains: "Twining"
    - path: "src/dashboard/public/style.css"
      provides: "Base dashboard styles"
      min_lines: 10
    - path: "src/dashboard/public/app.js"
      provides: "Client-side JavaScript shell with health check"
      contains: "api/health"
    - path: "src/index.ts"
      provides: "Dashboard startup integrated after MCP connect"
      contains: "startDashboard"
    - path: "package.json"
      provides: "open dependency and build:copy-assets script"
      contains: "open"
  key_links:
    - from: "src/index.ts"
      to: "src/dashboard/http-server.ts"
      via: "imports startDashboard, calls after server.connect"
      pattern: "startDashboard.*\\.catch"
    - from: "src/dashboard/public/app.js"
      to: "/api/health"
      via: "fetch call on page load"
      pattern: "fetch.*api/health"
    - from: "package.json"
      to: "src/dashboard/public/"
      via: "postbuild script copies assets to dist"
      pattern: "cp.*dashboard/public"
---

<objective>
Wire the dashboard into the MCP server lifecycle, create the static HTML/CSS/JS shell, add browser auto-open, graceful shutdown, and the build script for copying static assets.

Purpose: This completes Phase 7 by integrating the HTTP server (from Plan 01) into the actual MCP process. The dashboard becomes accessible when twining-mcp starts, without interfering with MCP stdio transport.

Output: Static dashboard assets, updated `src/index.ts`, updated `package.json`
</objective>

<execution_context>
@/Users/dave/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dave/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-http-server-foundation/07-RESEARCH.md
@.planning/phases/07-http-server-foundation/07-01-SUMMARY.md
@src/index.ts
@src/dashboard/http-server.ts
@src/dashboard/dashboard-config.ts
@package.json
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create static dashboard assets and add browser auto-open + graceful shutdown</name>
  <files>src/dashboard/public/index.html, src/dashboard/public/style.css, src/dashboard/public/app.js, src/dashboard/http-server.ts</files>
  <action>
Create `src/dashboard/public/index.html`:
- Minimal HTML5 page with `<title>Twining Dashboard</title>`
- Link to `style.css`, include `app.js` with `defer`
- Body contains: a header with "Twining Dashboard" title, a main content area with a status card showing connection status (loading indicator), and a footer with version info
- Use semantic HTML (`<header>`, `<main>`, `<footer>`)

Create `src/dashboard/public/style.css`:
- Clean, minimal styling using CSS custom properties for colors (prepares for dark mode in Phase 10)
- Define CSS variables: `--bg`, `--text`, `--card-bg`, `--card-border`, `--accent` (use a cool blue accent)
- Style the header, main content, status card, and footer
- Responsive: max-width container, centered, good spacing
- System font stack (`-apple-system, BlinkMacSystemFont, 'Segoe UI', ...`)
- Keep it simple -- this is a shell that Phase 8 will populate with real content

Create `src/dashboard/public/app.js`:
- On DOMContentLoaded, fetch `/api/health`
- On success, update the status card to show "Connected" with a green indicator
- On failure, show "Disconnected" with a red indicator
- Display the server name from the health response
- No framework, no build step -- vanilla JS

Update `src/dashboard/http-server.ts` to add:
- Browser auto-open: After `tryListen` succeeds, if `config.autoOpen` is true, dynamically `import('open')` and call `open(url)` wrapped in try/catch (non-fatal on failure). Use dynamic import so the `open` package is optional at runtime.
- Graceful shutdown: Export a `setupDashboardShutdown(httpServer: http.Server): void` function that registers `SIGTERM` and `SIGINT` handlers calling `httpServer.close()`. Use a 3-second force-exit timeout. Make sure handlers don't prevent normal process exit (use `process.exit(0)` in the timeout).
  </action>
  <verify>
1. Verify static files exist: `ls src/dashboard/public/`
2. Verify HTML is valid: `node -e "const fs=require('fs'); const html=fs.readFileSync('src/dashboard/public/index.html','utf8'); console.log(html.includes('Twining Dashboard') && html.includes('style.css') && html.includes('app.js'))"`
3. `npx tsc --noEmit` compiles without errors
  </verify>
  <done>Three static asset files exist in src/dashboard/public/ with a functional dashboard shell. http-server.ts has browser auto-open via dynamic import and graceful shutdown via signal handlers. All files compile.</done>
</task>

<task type="auto">
  <name>Task 2: Wire dashboard into MCP lifecycle and update build pipeline</name>
  <files>src/index.ts, package.json</files>
  <action>
Update `src/index.ts`:
- Add import: `import { startDashboard } from "./dashboard/http-server.js";`
- After `await server.connect(transport);`, add non-blocking dashboard startup:
  ```
  startDashboard(projectRoot).catch((err) => {
    console.error("[twining] Dashboard failed to start (non-fatal):", (err as Error).message);
  });
  ```
- CRITICAL: The `startDashboard` call must NOT be awaited. It is fire-and-forget. Dashboard failure must never prevent MCP from functioning.
- Do NOT add any other changes to index.ts. Keep it minimal.

Update `package.json`:
- Add `open` to dependencies: `"open": "^10.1.0"` (v10+ is ESM-native)
- Add postbuild script to copy static assets: `"postbuild": "cp -r src/dashboard/public dist/dashboard/public"`
- This ensures `npm run build` (which runs `tsc` then the postbuild) copies HTML/CSS/JS to dist/
- Add `src/dashboard/public` to the `"files"` array so it's included in npm publish
- Update version to `1.2.0-alpha.1` to reflect v1.2 work beginning

Run `npm install` to install the `open` package.

Run the full test suite to verify nothing is broken: `npx vitest run`
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds (compiles TS + copies static assets to dist/)
3. `ls dist/dashboard/public/` shows index.html, style.css, app.js
4. `npx vitest run` -- all existing tests still pass
5. Verify index.ts has non-blocking dashboard call: `grep "startDashboard.*catch" src/index.ts`
  </verify>
  <done>Dashboard starts automatically when twining-mcp launches. MCP stdio transport is unaffected. Static assets are copied to dist/ during build. The `open` package is installed. All existing tests pass. index.ts has fire-and-forget dashboard startup that never blocks or crashes MCP.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds -- both TS compilation and asset copy
2. `npx vitest run` -- all tests pass (existing + new from Plan 01)
3. `ls dist/dashboard/public/` shows all 3 static files
4. `grep -r "console.log" src/dashboard/` returns empty (no stdout writes)
5. `grep "startDashboard" src/index.ts` confirms integration
6. `grep "open" package.json` confirms dependency added
</verification>

<success_criteria>
- Static dashboard shell (index.html, style.css, app.js) exists and loads in browser
- Dashboard starts non-blockingly after MCP connects
- Browser auto-opens (when not disabled)
- Graceful shutdown on SIGTERM/SIGINT
- Build pipeline copies static assets
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-http-server-foundation/07-02-SUMMARY.md`
</output>
