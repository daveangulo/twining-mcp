---
phase: 07-http-server-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/dashboard/dashboard-config.ts
  - src/dashboard/http-server.ts
  - test/dashboard/http-server.test.ts
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-03
  - INFRA-05
  - INFRA-06

must_haves:
  truths:
    - "HTTP server can listen on a configurable port and serve static files from a directory"
    - "Port conflicts are handled by retrying subsequent ports up to a max retry count"
    - "Path traversal attempts return 403, missing files return 404"
    - "/api/health returns JSON {ok:true} as a routing skeleton"
    - "All server logging uses console.error, never console.log or stdout"
  artifacts:
    - path: "src/dashboard/dashboard-config.ts"
      provides: "DashboardConfig interface and getDashboardConfig() from env vars"
      exports: ["DashboardConfig", "getDashboardConfig"]
    - path: "src/dashboard/http-server.ts"
      provides: "HTTP server creation, static file serving, port retry, health endpoint"
      exports: ["startDashboard"]
    - path: "test/dashboard/http-server.test.ts"
      provides: "Tests for static serving, port retry, path traversal prevention, health endpoint"
      min_lines: 80
  key_links:
    - from: "src/dashboard/http-server.ts"
      to: "src/dashboard/dashboard-config.ts"
      via: "imports getDashboardConfig"
      pattern: "import.*getDashboardConfig.*dashboard-config"
    - from: "src/dashboard/http-server.ts"
      to: "node:http"
      via: "createServer for HTTP handling"
      pattern: "http\\.createServer"
---

<objective>
Create the core HTTP server module for the Twining dashboard, including configuration from environment variables, static file serving with security, port conflict retry logic, and a health endpoint.

Purpose: This is the foundation that all later dashboard phases build on. Getting the HTTP server right -- especially non-blocking startup, no stdout corruption, and port retry -- prevents the critical bugs identified in research (Serena issues #648, #268).

Output: `src/dashboard/dashboard-config.ts`, `src/dashboard/http-server.ts`, `test/dashboard/http-server.test.ts`
</objective>

<execution_context>
@/Users/dave/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dave/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-http-server-foundation/07-RESEARCH.md
@src/index.ts
@src/config.ts
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard config and HTTP server module</name>
  <files>src/dashboard/dashboard-config.ts, src/dashboard/http-server.ts</files>
  <action>
Create `src/dashboard/dashboard-config.ts`:
- Export `DashboardConfig` interface with fields: `port: number`, `enabled: boolean`, `autoOpen: boolean`
- Export `getDashboardConfig()` function that reads from environment variables:
  - `TWINING_DASHBOARD_PORT` -> port (default 24282)
  - `TWINING_DASHBOARD` -> enabled (default true, disabled when `'0'`)
  - `TWINING_DASHBOARD_NO_OPEN` -> autoOpen (default true, disabled when `'1'`)

Create `src/dashboard/http-server.ts`:
- Import `http` from `node:http`, `fs` from `node:fs/promises`, `path` from `node:path`, `{ fileURLToPath }` from `node:url`
- Import `getDashboardConfig` from `./dashboard-config.js`
- Define MIME_TYPES map: `.html` -> `text/html; charset=utf-8`, `.css` -> `text/css; charset=utf-8`, `.js` -> `application/javascript; charset=utf-8`, `.json` -> `application/json; charset=utf-8`, `.svg` -> `image/svg+xml`, `.png` -> `image/png`, `.ico` -> `image/x-icon`
- Implement `serveStatic(publicDir: string)` returning an async request handler:
  - Parse URL from `req.url`, default `/` to `/index.html`
  - Resolve the file path and verify it starts with the resolved publicDir (path traversal prevention -> 403 Forbidden)
  - Read the file with `fs.readFile`, serve with correct Content-Type from MIME_TYPES (default `application/octet-stream`)
  - On ENOENT -> 404 Not Found
- Implement `tryListen(server: http.Server, port: number, maxRetries: number): Promise<number>`:
  - Use `server.once('error', ...)` to catch `EADDRINUSE` and retry with port+1 up to maxRetries
  - Bind to `127.0.0.1` only (security)
  - Return the actual port the server bound to
- Implement `handleRequest(publicDir: string)` returning an async handler:
  - Route `/api/health` -> JSON response `{"ok":true,"server":"twining-mcp"}`
  - Route everything else -> `serveStatic(publicDir)`
- Export `startDashboard(projectRoot: string): Promise<{ server: http.Server; port: number } | null>`:
  - Call `getDashboardConfig()` -- if not enabled, return null
  - Resolve `publicDir` using `import.meta.url` to find `public/` relative to the compiled file
  - Create `http.createServer(handleRequest(publicDir))`
  - Call `tryListen` with configured port and maxRetries=5
  - Log to stderr: `[twining] Dashboard: http://127.0.0.1:{port}`
  - Return `{ server, port }`
- CRITICAL: Never use `console.log` or write to `process.stdout` anywhere in this module. All output via `console.error`.
  </action>
  <verify>Run `npx tsc --noEmit` to verify the module compiles without errors.</verify>
  <done>Both modules compile. dashboard-config exports getDashboardConfig returning config from env vars. http-server exports startDashboard that creates an HTTP server with static file serving, port retry, health endpoint, and all logging to stderr.</done>
</task>

<task type="auto">
  <name>Task 2: Write tests for HTTP server</name>
  <files>test/dashboard/http-server.test.ts</files>
  <action>
Create `test/dashboard/http-server.test.ts` using vitest:

Test `getDashboardConfig`:
- Returns defaults when no env vars set (port 24282, enabled true, autoOpen true)
- Reads `TWINING_DASHBOARD_PORT` as number
- `TWINING_DASHBOARD=0` sets enabled to false
- `TWINING_DASHBOARD_NO_OPEN=1` sets autoOpen to false

Test static file serving (create temp directory with test files):
- Serves `index.html` for `/` request
- Serves CSS file with correct Content-Type
- Returns 404 for missing file
- Returns 403 for path traversal attempt (`/../../../etc/passwd`)
- Returns correct MIME type for `.js` files

Test `/api/health` endpoint:
- Returns 200 with `{"ok":true,"server":"twining-mcp"}`
- Returns correct `application/json` Content-Type

Test port retry:
- When preferred port is in use, server starts on next available port
- Verify by pre-binding a server to the target port, then calling startDashboard

Test `startDashboard`:
- Returns null when `TWINING_DASHBOARD=0`
- Returns `{ server, port }` on success
- Clean up: close server after each test

Use `http.request` or `fetch` for HTTP assertions. Use `beforeEach`/`afterEach` for env var save/restore and server cleanup. Set env vars directly on `process.env` and restore in afterEach.
  </action>
  <verify>Run `npx vitest run test/dashboard/http-server.test.ts` -- all tests pass.</verify>
  <done>All tests pass covering: config defaults and env var parsing, static file serving with correct MIME types, 404 for missing files, 403 for path traversal, health endpoint JSON response, port retry when port in use, and disabled dashboard returning null.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npx vitest run test/dashboard/http-server.test.ts` passes all tests
3. No `console.log` or `process.stdout.write` in any dashboard file: `grep -r "console.log\|process.stdout" src/dashboard/` returns empty
</verification>

<success_criteria>
- dashboard-config.ts exports DashboardConfig type and getDashboardConfig function
- http-server.ts exports startDashboard function that creates HTTP server with static serving, port retry, and health endpoint
- All tests pass
- No stdout writes in dashboard code
</success_criteria>

<output>
After completion, create `.planning/phases/07-http-server-foundation/07-01-SUMMARY.md`
</output>
