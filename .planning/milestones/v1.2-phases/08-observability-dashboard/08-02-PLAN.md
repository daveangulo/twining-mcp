---
phase: 08-observability-dashboard
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - src/dashboard/public/index.html
  - src/dashboard/public/style.css
  - src/dashboard/public/app.js
autonomous: true
requirements: [OBS-06, OBS-07]

must_haves:
  truths:
    - "Dashboard polls the active tab's data endpoint plus /api/status every 3 seconds"
    - "Polling stops when the browser tab is hidden (document.hidden === true)"
    - "Polling resumes with an immediate refresh when the tab becomes visible again"
    - "Multiple calls to startPolling do not create duplicate timers"
    - "Tab navigation changes which endpoint is polled without creating timer leaks"
  artifacts:
    - path: "src/dashboard/public/app.js"
      provides: "Full dashboard client: tab navigation, data fetching, table rendering with sorting/pagination, detail inspector, polling with visibility-aware lifecycle"
      min_lines: 200
    - path: "src/dashboard/public/index.html"
      provides: "Dashboard HTML structure with tab navigation, stats cards, data tables, pagination controls, detail inspector panel"
      min_lines: 50
    - path: "src/dashboard/public/style.css"
      provides: "Dashboard styles for tabs, stats grid, tables, pagination, detail panel, master-detail layout"
      min_lines: 100
  key_links:
    - from: "src/dashboard/public/app.js"
      to: "/api/status"
      via: "fetch in refreshData polling loop"
      pattern: "fetch.*api/status"
    - from: "src/dashboard/public/app.js"
      to: "/api/blackboard"
      via: "fetch when blackboard tab is active"
      pattern: "fetch.*api/blackboard"
    - from: "src/dashboard/public/app.js"
      to: "/api/decisions"
      via: "fetch when decisions tab is active"
      pattern: "fetch.*api/decisions"
    - from: "src/dashboard/public/app.js"
      to: "/api/graph"
      via: "fetch when graph tab is active"
      pattern: "fetch.*api/graph"
    - from: "src/dashboard/public/app.js"
      to: "document.visibilitychange"
      via: "addEventListener visibilitychange to pause/resume polling"
      pattern: "visibilitychange"
---

<objective>
Build the full dashboard frontend with tab navigation, data rendering, sorting, pagination, detail inspector, and auto-refresh polling that pauses when the tab is hidden.

Purpose: The API endpoints from Plan 01 provide JSON data but users need a visual interface to browse Twining state. This plan creates the complete client-side application that fetches data from those endpoints, renders it in sortable/paginated tables, and auto-refreshes on a 3-second polling cycle with visibility-aware lifecycle management.

Output: Fully functional `index.html`, `style.css`, and `app.js` replacing the Phase 7 shell.
</objective>

<execution_context>
@/Users/dave/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dave/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-observability-dashboard/08-RESEARCH.md
@.planning/phases/08-observability-dashboard/08-01-SUMMARY.md

Key existing code:
@src/dashboard/public/index.html (Phase 7 shell -- replace entirely)
@src/dashboard/public/style.css (Phase 7 styles -- replace entirely)
@src/dashboard/public/app.js (Phase 7 health check -- replace entirely)
@src/dashboard/api-routes.ts (Plan 01 output -- API endpoints this UI consumes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build dashboard HTML structure and CSS styles</name>
  <files>src/dashboard/public/index.html, src/dashboard/public/style.css</files>
  <action>
Replace the Phase 7 shell `index.html` with the full dashboard layout. Replace `style.css` with comprehensive dashboard styles.

**index.html structure:**

1. `<header>` -- "Twining Dashboard" title with a connection status indicator (dot + text) and a polling status indicator (shows "Polling" / "Paused" with a small dot).

2. `<nav class="tabs">` -- Four tab buttons: Stats (default active), Blackboard, Decisions, Graph. Each button has `data-tab="stats|blackboard|decisions|graph"` and class `tab-btn`. The Stats tab is active by default.

3. `<main>` containing four `<div class="tab-content">` sections, each with `id="tab-stats"`, `id="tab-blackboard"`, `id="tab-decisions"`, `id="tab-graph"`. Only the active tab is visible (`style="display:block"` on stats, `style="display:none"` on others).

4. **Stats tab** (`tab-stats`): A grid of 6 stat cards, each with a label and value span:
   - Blackboard Entries (id="stat-bb-entries")
   - Active Decisions (id="stat-active-decisions")
   - Provisional Decisions (id="stat-provisional-decisions")
   - Graph Entities (id="stat-graph-entities")
   - Graph Relations (id="stat-graph-relations")
   - Last Activity (id="stat-last-activity")

   Below the grid, an uninitialized message div (id="uninitialized-msg", hidden by default): "No data yet. Twining will populate as agents use MCP tools."

5. **Blackboard tab** (`tab-blackboard`): Master-detail layout.
   - Left panel: `<div class="list-panel">` containing a `<table class="data-table" id="blackboard-table">` with thead columns: Timestamp, Type, Scope, Summary (each `<th>` has `data-sort-key` matching the field name and class `sortable-header`). Empty `<tbody>`. Below the table, `<div class="pagination" id="blackboard-pagination">`.
   - Right panel: `<div class="detail-panel" id="blackboard-detail">` with placeholder text "Select an entry to view details".

6. **Decisions tab** (`tab-decisions`): Same master-detail layout.
   - Table id="decisions-table" with columns: Timestamp, Domain, Scope, Summary, Status, Confidence. Each th has `data-sort-key`.
   - Pagination div id="decisions-pagination".
   - Detail panel id="decisions-detail".

7. **Graph tab** (`tab-graph`): Same master-detail layout.
   - Table id="graph-table" with columns: Name, Type, Properties.
   - Pagination div id="graph-pagination".
   - Detail panel id="graph-detail".
   - Below the table area, a section for relations count: `<p id="graph-relations-info">`.

8. `<footer>` -- "Twining MCP Server" text.

**style.css -- replace entirely with:**

Keep the existing `:root` CSS variables (--bg, --text, --card-bg, --card-border, --accent, --success, --error). Add `--warning: #f59e0b;` and `--muted: #64748b;`.

- `body`: same as Phase 7 (flex column, min-height 100vh)
- `header`: flex row with space-between, align items center. Title on left, status indicators on right.
- `.connection-status`, `.poll-status`: flex row, gap 0.5rem, align center, font-size 0.8125rem
- `.status-dot` (reuse Phase 7 pattern): 8px circle, colored by `.connected`/`.disconnected`/`.polling`/`.paused`
- `.tabs`: flex row, gap 0, border-bottom 2px solid var(--card-border). `max-width: 1200px; margin: 0 auto; width: 100%; padding: 0 1.5rem;`
- `.tab-btn`: padding 0.75rem 1.25rem, background transparent, border none, cursor pointer, font-size 0.875rem, font-weight 500, color var(--muted), border-bottom 2px solid transparent, margin-bottom -2px.
- `.tab-btn.active`: color var(--accent), border-bottom-color var(--accent).
- `main`: max-width 1200px (wider than Phase 7's 960px to fit master-detail), margin 0 auto, padding 1.5rem.
- `.stats-grid`: display grid, grid-template-columns repeat(3, 1fr), gap 1rem. On `@media (max-width: 768px)`: grid-template-columns repeat(2, 1fr).
- `.stat-card`: background var(--card-bg), border 1px solid var(--card-border), border-radius 8px, padding 1.25rem. `.stat-label`: font-size 0.75rem, text-transform uppercase, letter-spacing 0.05em, color var(--muted), margin-bottom 0.5rem. `.stat-value`: font-size 1.5rem, font-weight 700.
- `.content-area`: display grid, grid-template-columns 1fr 380px, gap 1rem, min-height 0. `@media (max-width: 900px)`: grid-template-columns 1fr (stacked).
- `.list-panel`: overflow-x auto.
- `.data-table`: width 100%, border-collapse collapse, font-size 0.8125rem. `th`: text-align left, padding 0.5rem 0.75rem, border-bottom 2px solid var(--card-border), font-weight 600, font-size 0.75rem, text-transform uppercase, color var(--muted). `td`: padding 0.5rem 0.75rem, border-bottom 1px solid var(--card-border).
- `.sortable-header`: cursor pointer. On hover: color var(--text). `.sortable-header.sort-asc::after`: content " ↑". `.sortable-header.sort-desc::after`: content " ↓".
- `tbody tr`: cursor pointer. `tbody tr:hover`: background-color #f1f5f9. `tbody tr.selected`: background-color #e0f2fe.
- `.pagination`: display flex, align-items center, justify-content space-between, padding 0.75rem 0, font-size 0.8125rem. `.pagination button`: padding 0.25rem 0.75rem, border 1px solid var(--card-border), border-radius 4px, background var(--card-bg), cursor pointer. `.pagination button:disabled`: opacity 0.4, cursor default.
- `.detail-panel`: background var(--card-bg), border 1px solid var(--card-border), border-radius 8px, padding 1.25rem, overflow-y auto, max-height calc(100vh - 200px), word-break break-word. `.detail-panel .placeholder`: color var(--muted), font-style italic.
- `.detail-panel h3`: font-size 0.875rem, margin-bottom 0.75rem.
- `.detail-field`: margin-bottom 0.75rem. `.detail-label`: font-size 0.6875rem, text-transform uppercase, letter-spacing 0.05em, color var(--muted), margin-bottom 0.25rem. `.detail-value`: font-size 0.8125rem.
- `.detail-value pre`: white-space pre-wrap, font-size 0.75rem, background var(--bg), padding 0.5rem, border-radius 4px, overflow-x auto.
- `.badge`: display inline-block, padding 0.125rem 0.5rem, border-radius 10px, font-size 0.6875rem, font-weight 600. `.badge.active`: background #dcfce7, color #166534. `.badge.provisional`: background #fef3c7, color #92400e. `.badge.superseded`: background #f1f5f9, color #475569. `.badge.overridden`: background #fecaca, color #991b1b.
- `#uninitialized-msg`: text-align center, padding 2rem, color var(--muted), font-style italic, display none.
- `footer`: same as Phase 7.
  </action>
  <verify>
Open `src/dashboard/public/index.html` in a browser directly (file:// protocol). Verify the layout renders: header with title, tab buttons visible, stats grid with placeholder values, table structures present. No console errors.
  </verify>
  <done>
index.html has complete dashboard structure with tabs, stats, tables, detail panels. style.css has all layout and component styles. Page renders without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build app.js with data fetching, rendering, sorting, pagination, detail inspector, and visibility-aware polling</name>
  <files>src/dashboard/public/app.js</files>
  <action>
Replace the Phase 7 health check `app.js` with the complete dashboard application. Use vanilla JavaScript (no ES modules, no build step). All user-provided text MUST use `textContent` (never `innerHTML`) to prevent XSS.

**Application state object:**
```javascript
var state = {
  activeTab: "stats",
  // Per-tab state
  blackboard: { data: [], sortKey: "timestamp", sortDir: "desc", page: 1, pageSize: 25, selectedId: null },
  decisions: { data: [], sortKey: "timestamp", sortDir: "desc", page: 1, pageSize: 25, selectedId: null },
  graph: { data: [], relations: [], sortKey: "name", sortDir: "asc", page: 1, pageSize: 25, selectedId: null },
  status: null,
  // Polling
  pollTimer: null,
  pollInterval: 3000,
  connected: false,
};
```

**Tab navigation (`switchTab`):**
- Hide all `.tab-content` divs (set display none).
- Show the selected tab div (display block).
- Update `.tab-btn` active class.
- Set `state.activeTab` to the new tab name.
- Call `stopPolling()` then `startPolling()` to reset the polling timer for the new tab's endpoint.
- Immediately fetch data for the new tab.

**Data fetching functions:**
- `fetchStatus()`: GET `/api/status`, update `state.status`, call `renderStatus()`. On error, set `state.connected = false`, update connection indicator.
- `fetchBlackboard()`: GET `/api/blackboard`, update `state.blackboard.data` from response entries, call `renderBlackboard()`.
- `fetchDecisions()`: GET `/api/decisions`, update `state.decisions.data` from response decisions, call `renderDecisions()`.
- `fetchGraph()`: GET `/api/graph`, update `state.graph.data` from response entities, `state.graph.relations` from response relations, call `renderGraph()`.
- `fetchDecisionDetail(id)`: GET `/api/decisions/{id}`, call `renderDecisionDetail(data)` on success. On 404, show "Decision not found" in detail panel.

Each fetch function: use `fetch()` with `.then()` chaining (not async/await to avoid transpile concerns). On success set `state.connected = true` and update connection indicator. On network error set `state.connected = false`.

**refreshData() -- the polling callback:**
- Always call `fetchStatus()` (stats header always refreshes).
- Based on `state.activeTab`, also call the active tab's fetch function:
  - "stats": only fetchStatus (already called)
  - "blackboard": fetchBlackboard()
  - "decisions": fetchDecisions()
  - "graph": fetchGraph()

**Polling lifecycle (OBS-06, OBS-07):**
```javascript
function startPolling() {
  if (state.pollTimer) return; // prevent duplicate timers
  state.pollTimer = setInterval(refreshData, state.pollInterval);
  updatePollIndicator(true);
}

function stopPolling() {
  if (state.pollTimer) {
    clearInterval(state.pollTimer);
    state.pollTimer = null;
  }
  updatePollIndicator(false);
}
```

**Visibility-aware lifecycle (OBS-07):**
```javascript
document.addEventListener("visibilitychange", function() {
  if (document.hidden) {
    stopPolling();
  } else {
    refreshData(); // immediate refresh on return
    startPolling();
  }
});
```

**updatePollIndicator(isPolling):** Update the polling status dot and text in the header. Dot class "polling" (green) when active, "paused" (yellow/amber) when paused.

**updateConnectionIndicator():** Update the connection status dot. "connected" (green) when `state.connected`, "disconnected" (red) when not.

**renderStatus():** For each stat card, set the value span's `textContent`:
- `stat-bb-entries`: `state.status.blackboard_entries`
- `stat-active-decisions`: `state.status.active_decisions`
- `stat-provisional-decisions`: `state.status.provisional_decisions`
- `stat-graph-entities`: `state.status.graph_entities`
- `stat-graph-relations`: `state.status.graph_relations`
- `stat-last-activity`: format `state.status.last_activity` with `formatTimestamp()` helper (use `new Date(ts).toLocaleString()` or "Never" if "none")
- Show/hide `#uninitialized-msg` based on `state.status.initialized === false`.

**Sorting (`sortData`, `handleSort`):**
- `sortData(data, key, dir)`: Return a shallow copy sorted by key. Compare with `<` / `>`. Direction "asc" or "desc".
- `handleSort(tabName, key)`: If already sorting by this key, toggle direction. Otherwise set key and direction "asc". Reset page to 1. Re-render the tab.
- Attach click handlers to all `.sortable-header` th elements. On click, read `data-sort-key` and call `handleSort`.
- Update header classes: remove `sort-asc`/`sort-desc` from all headers in the table, add appropriate class to active sort header.

**Pagination (`paginate`, `renderPagination`):**
- `paginate(data, page, pageSize)`: Return slice `[(page-1)*pageSize, page*pageSize]`.
- `renderPagination(containerId, totalItems, tabState)`: Build pagination controls using `createElement`. Show "Page X of Y (Z items)". Previous/Next buttons. Previous disabled when page 1, Next disabled when last page.
- Page change updates `tabState.page` and re-renders the tab.

**Table rendering:**
- `renderBlackboard()`: Sort `state.blackboard.data` by sortKey/sortDir. Paginate. Clear tbody of `#blackboard-table`. For each entry, create `<tr>` with `data-id`. Columns: timestamp (formatted), entry_type, scope (or "--"), summary (truncated to 80 chars). Attach click handler to set `state.blackboard.selectedId` and render detail. Highlight selected row with `.selected` class. Call `renderPagination("blackboard-pagination", ...)`.
- `renderDecisions()`: Same pattern. Columns: timestamp, domain, scope, summary (truncated), status (as badge), confidence (as badge). Click handler fetches full decision detail via `fetchDecisionDetail(id)`.
- `renderGraph()`: Same pattern for entities. Columns: name, type, properties (JSON.stringify, truncated). Click shows entity detail inline. Also update `#graph-relations-info` with relation count.

**Detail rendering:**
- `renderBlackboardDetail(entry)`: In `#blackboard-detail`, show all fields: id, timestamp, entry_type, summary, detail (if present), scope, tags (comma-separated), agent_id, relates_to. Use `createElement` + `textContent` for all values. For detail field, use `<pre>` for long text.
- `renderDecisionDetail(decision)`: In `#decisions-detail`, show: id, timestamp, domain, scope, summary, status (badge), confidence (badge), context, rationale, constraints (bullet list), alternatives (each with option, pros, cons, reason_rejected), affected_files, affected_symbols, commit_hashes, depends_on, supersedes. Use `createElement` + `textContent` throughout.
- `renderGraphDetail(entity)`: In `#graph-detail`, show: id, name, type, all properties as key-value pairs, timestamp.

**Helper functions:**
- `formatTimestamp(ts)`: Return `new Date(ts).toLocaleString()` or "Never" / "--" for null/undefined/"none".
- `truncate(str, len)`: Return str if shorter than len, otherwise `str.slice(0, len) + "..."`.
- `createElement(tag, className, textContent)`: Convenience wrapper. Returns element.
- `createBadge(text)`: Creates a span with class `badge` and the text lowercased as additional class (e.g., `badge active`).
- `clearElement(el)`: Remove all children from an element.

**Initialization (DOMContentLoaded):**
1. Attach click handlers to all `.tab-btn` elements for tab switching.
2. Attach click handlers to all `.sortable-header` elements for sorting.
3. Call `refreshData()` for initial data load.
4. Call `startPolling()` to begin the polling cycle.
5. Register the `visibilitychange` listener.

**Important constraints:**
- Never use `innerHTML` for user-provided content. Only use it for structural HTML with no user data (e.g., clearing a container with `innerHTML = ""`).
- Store selected item by ID, not array index. After data refresh, look up by ID. If item no longer exists, show "Item no longer exists" message and clear selection.
- When polling refreshes data, preserve the current selection (selectedId) and page number. Do NOT reset page or selection on refresh.
  </action>
  <verify>
1. Run `npx tsc --noEmit` to verify no TypeScript regressions.
2. Start the server: `npm run build && node dist/index.js` (or equivalent).
3. Open `http://localhost:24282` in a browser.
4. Verify tabs switch correctly.
5. Verify the polling indicator shows "Polling" and the connection indicator shows "Connected".
6. Switch to a different browser tab, wait 5 seconds, switch back. Verify polling indicator showed "Paused" while away and "Polling" after return.
7. Open browser DevTools Network tab. Verify requests happen every ~3 seconds. Verify only the active tab's endpoint + /api/status are polled (not all endpoints).
8. Verify table sorting works (click column headers, arrows appear).
9. Verify pagination works (if enough entries exist).
10. Verify clicking a table row shows details in the inspector panel.
  </verify>
  <done>
Dashboard frontend is fully functional. Tab navigation works. Stats display correctly. Tables render with sorting and pagination. Detail inspector shows full item details on click. Polling refreshes data every 3 seconds. Polling pauses when tab is hidden and resumes with immediate refresh when visible. No XSS vectors (all user content via textContent). No duplicate timer leaks.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- clean TypeScript compilation (no regressions from static file changes)
2. Open dashboard in browser -- all 4 tabs render correctly
3. Stats tab shows operational numbers that update on polling
4. Blackboard/Decisions/Graph tabs show sortable, paginated tables
5. Clicking a row shows detail in inspector panel
6. Network tab shows 3-second polling interval for active tab + status
7. Switching browser tab away pauses polling; switching back resumes with immediate refresh
8. Polling indicator in header reflects current state (Polling vs Paused)
9. No console errors during normal operation
</verification>

<success_criteria>
Dashboard auto-refreshes via 3-second polling (OBS-06). Polling pauses on tab hide and resumes on tab visible (OBS-07). No timer leaks from tab switching or visibility changes. All user data rendered via textContent (no XSS). Frontend consumes all 5 API endpoints from Plan 01.
</success_criteria>

<output>
After completion, create `.planning/phases/08-observability-dashboard/08-02-SUMMARY.md`
</output>
